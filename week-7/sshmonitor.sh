#!/bin/bash

# Đường dẫn tới file lưu danh sách các phiên đăng nhập mới
LOG_FILE="/var/log/sshmonitor.log"

# Thời gian hiện tại
CURRENT_TIME=$(date +"%H:%M:%S %d/%m/%Y")

# Kiểm tra danh sách phiên đăng nhập mới và ghi vào file log
{
  echo "[SSH Monitor - $CURRENT_TIME]"

  # Lấy danh sách các phiên đăng nhập mới
  NEW_SESSIONS=$(journalctl _COMM=sshd --since "5 minutes ago" | grep "Accepted password\|Accepted publickey" | awk '{print $1, $2, $3, $10, $11}')

  # Ghi vào file log
  if [ -n "$NEW_SESSIONS" ]; then
    echo "=== Danh sach phiên dang nhap moi ==="
    echo "$NEW_SESSIONS"
  fi

} >> "$LOG_FILE"

# Kiểm tra xem có phiên đăng nhập mới hay không
if [ -s "$LOG_FILE" ]; then
  # Gửi email cho quản trị viên root@localhost
  mail -s "SSH Monitor - $CURRENT_TIME" root@localhost < "$LOG_FILE"
fi

# crontab -e
# */5 * * * * /path/to/sshmonitor.sh
