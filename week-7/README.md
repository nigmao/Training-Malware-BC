# Linux Internals

## [1]. Lý thuyết:

- `1.` Cài đặt OS, phần mềm

  - `1.1.` Cài đặt Ubuntu
  - `1.2.` Cài đặt phần mềm: Cài đặt một số phần mềm thông dụng theo các cách khác nhau

    - Chạy file .deb

    ```bash
    sudo dpkg -i <file>.deb
    sudo apt-get install -f  # Để giải quyết các phụ thuộc không đầy đủ (nếu có)
    ```

    - Cài qua apt-get

    ```bash
    sudo apt-get update  # Cập nhật danh sách gói
    sudo apt-get install <package>
    ```

    - Build từ source code

    ```bash
    # Cài đặt các gói phụ thuộc cần thiết
    sudo apt-get install build-essential
    sudo apt-get install tên_gói_phụ_thuộc

    # Giải nén mã nguồn (nếu là file tar.gz)
    tar -xzvf <file>.tar.gz

    # Di chuyển vào thư mục mã nguồn
    cd tên_thư_mục

    # Thực hiện quy trình build
    ./configure
    make
    sudo make install
    ```

- `2.` Tìm hiểu lệnh: Tìm hiểu một số lệnh hay dùng

  - Xem thông tin OS

    - Tên, phiên bản, kiến trúc (32-bit hay 64-bit).

    ```bash
    # Xem tên và phiên bản của hệ điều hành:
    lsb_release -a
    # or
    cat /etc/os-release

    # Xem kiến trúc hệ điều hành (32-bit hay 64-bit):
    uname -m
    ```

    - Danh sách các gói phần mềm được cài đặt.

    ```bash
    # Xem tất cả các gói đã cài đặt:
    dpkg --list
    dpkg --list | grep tên_gói

    # Xem thông tin chi tiết về một gói cài đặt:
    dpkg -s tên_gói
    ```

  - Xem cấu hình máy
    - CPU
    - RAM
    - Ổ cứng
  - Xem thông tin về mạng
    - Địa chỉ IP, Gateway, DNS...
    - Các kết nối đang mở và tiến trình tương ứng.
  - Quản lý tiến trình
    - Xem danh sách các tiến trình đang chạy: Tên, PID, User, Lệnh để chạy tiến trình
    - Tắt tiến trình theo PID
    - Tắt tiến trình theo tên
  - Tìm kiếm file

    - Tìm theo tên (phân biệt / không phân biệt hoa thường)
    - Tìm theo owner / group
    - Tìm theo thời gian chỉnh sửa / truy cập cuối
    - Tìm theo dung lượng
    - Tìm theo nội dung file

  - Đặt lịch chạy định kỳ

    - Chạy lệnh X định kỳ vào 0h00 mỗi ngày
    - Chạy lệnh Y định kỳ vào 8h00 từ thứ hai đến thứ sáu
    - Chạy lệnh Z định kỳ mỗi 3h một lần vào ngày 15 của tháng

  - Phân quyền
    - Tạo mới 3 user: UserA và UserB thuộc GroupX, UserC thuộc GroupY
    - Phân quyền file F1 chỉ cho phép thực thi bởi UserA / GroupX
    - Phân quyền thư mục D1 cho phép mọi user có quyền đọc file bên trong thư mục nhưng chỉ UserA / GroupX được tạo file mới
    - Phân quyền thư mục D2 chỉ cho phép UserA / Group A được xem danh sách file trong thư mục đó

> 2.

### 1. Xem cấu hình máy:

- **Xem thông tin về CPU:**

  ```bash
  lscpu
  ```

- **Xem thông tin về RAM:**

  ```bash
  free -h
  ```

- **Xem thông tin về ổ cứng:**
  ```bash
  df -h
  ```

### 2. Xem thông tin về mạng:

- **Xem địa chỉ IP, Gateway, DNS:**

  ```bash
  ip addr show
  route -n
  cat /etc/resolv.conf
  ```

- **Xem các kết nối đang mở và tiến trình tương ứng:**
  ```bash
  netstat -tuln
  ss -tuln
  ```

### 3. Quản lý tiến trình:

- **Xem danh sách các tiến trình đang chạy:**

  ```bash
  ps aux
  ```

- **Tắt tiến trình theo PID:**

  ```bash
  sudo kill -9 PID
  ```

- **Tắt tiến trình theo tên:**
  ```bash
  pkill -f tên_tiến_trình
  ```

### 4. Tìm kiếm file:

- **Tìm theo tên (phân biệt / không phân biệt hoa thường):**

  - Tìm theo tên file (phân biệt hoa thường):

  ```bash
  find /đường/dẫn -type f -name "tên_file"
  ```

  - Tìm theo tên file (không phân biệt hoa thường):

  ```bash
  find /đường/dẫn -type f -iname "tên_file"
  ```

  - Trong lệnh `-iname`, tùy chọn "i" biểu thị không phân biệt hoa thường.

- **Tìm theo owner / group:**

  ```bash
  find /đường/dẫn -user owner_name -or -group group_name
  ```

- **Tìm theo thời gian chỉnh sửa / truy cập cuối:**

  ```bash
  find /đường/dẫn -mtime +n  # tìm file chỉnh sửa trước n ngày
  ```

- **Tìm theo dung lượng:**

  ```bash
  find /đường/dẫn -size +nM  # tìm file lớn hơn n megabytes
  ```

- **Tìm theo nội dung file:**
  ```bash
  grep -r "nội_dung" /đường/dẫn
  ```

### 5. Đặt lịch chạy định kỳ:

- **Chạy lệnh X định kỳ vào 0h00 mỗi ngày:**

  ```bash
  0 0 * * * lệnh_X
  ```

- **Chạy lệnh Y định kỳ vào 8h00 từ thứ hai đến thứ sáu:**

  ```bash
  0 8 * * 1-5 lệnh_Y
  ```

- **Chạy lệnh Z định kỳ mỗi 3h một lần vào ngày 15 của tháng:**

  ```bash
  0 */3 15 * * /đường/dẫn/lệnh_Z
  ```

### 6. Phân quyền:

- **Tạo mới 3 user: UserA và UserB thuộc GroupX, UserC thuộc GroupY:**

  ```bash
  sudo adduser UserA
  sudo adduser UserB
  sudo adduser UserC

  sudo addgroup GroupX
  sudo addgroup GroupY

  sudo usermod -aG GroupX UserA
  sudo usermod -aG GroupX UserB
  sudo usermod -aG GroupY UserC
  ```

- **Phân quyền file F1 chỉ cho phép thực thi bởi UserA / GroupX:**

  ```bash
  chmod 750 F1 # Phân quyền: Owner có quyền đọc, ghi và thực thi; Group có quyền đọc và thực thi; Others không có quyền nào.
  chown UserA:GroupX F1 # Gán file F1 cho UserA và GroupX
  ```

- **Phân quyền thư mục D1 cho phép mọi user có quyền đọc file bên trong thư mục nhưng chỉ UserA / GroupX được tạo file mới:**

  ```bash
    # Tạo thư mục D1
    mkdir D1

    # Phân quyền thư mục D1
    chmod 755 D1  # Owner có quyền đọc, ghi và thực thi; Group và Others có quyền đọc và thực thi.
    chown :GroupX D1  # Gán thư mục D1 cho GroupX
    chmod g+s D1  # Set sticky bit để các tập tin mới được tạo trong thư mục D1 sẽ kế thừa group của thư mục D1

    # Tạo file bên trong thư mục D1 (mọi user có quyền đọc)
    touch D1/file1
    chmod 644 D1/file1

    # Cho phép UserA / GroupX tạo file mới trong thư mục D1
    sudo -u UserA touch D1/file2
  ```

- **Phân quyền thư mục D2 chỉ cho phép UserA / Group A được xem danh sách file trong thư mục đó:**

  ```bash
    # Tạo thư mục D2
    mkdir D2

    # Phân quyền thư mục D2
    chmod 710 D2  # Owner (UserA) có quyền đọc, ghi và thực thi; Group (GroupA) có quyền thực thi; Others không có quyền nào.
    chown UserA:GroupA D2  # Gán thư mục D2 cho UserA và GroupA
  ```

## [2]. Thực hành:

- `3.` Thực hành

  - `3.1.` Lấy thông tin hệ thống: Viết shell script `info.sh` hiển thị các thông tin về hệ thống, bao gồm:

    - `1.` Tên máy, tên bản phân phối
    - `2.` Phiên bản hệ điều hành
    - `3.` Thông tin CPU (tên, 32-bit hay 64-bit, tốc độ)
    - `4.` Thông tin bộ nhớ vật lí (tổng bao nhiêu MB)
    - `5.` Thông tin ổ đĩa còn trống bao nhiêu MB
    - `6.` Danh sách địa chỉ IP của hệ thống
    - `7.` Danh sách user trên hệ thống (sắp xếp theo thứ tự abc)
    - `8.` Thông tin các tiến trình đang chạy với quyền root (sắp xếp theo thứ tự abc)
    - `9.` Thông tin các port đang mở (sắp xếp theo port tăng dần)
    - `10.` Danh sách các thư mục trên hệ thống cho phép other có quyền ghi
    - `11.` Danh sách các gói phần mềm (tên gói, phiên bản) được cài trên hệ thống
    - Ví dụ đầu ra:

    ```bash
    [Thong tin he thong]
    Ten may: myname
    Ten ban phan phoi: Ubuntu 14.04.4
    ...
    ```

- `3.2.` Xử lý file: Viết shell script `checketc.sh` đặt lịch chạy định kỳ 30 phút/lần để thực hiện:

  - `1.` Kiểm tra thư mục /etc có file nào được tạo mới (so với lần chạy trước) không? Nếu có, hiển thị thông tin file đó và nếu là file text thì hiển thị 10 dòng đầu tiên của file
  - `2.` Kiểm tra thư mục /etc có file nào thay đổi không? Nếu có hiển thị tên file bị thay đổi
  - `3.` Thư mục /etc có file nào bị xóa không? Nếu có hiển thị tên file bị xóa
  - `4.` Đẩy log ra file /var/log/checketc.log
  - `5.` Gửi email cho quản trị viên root@localhost
  - Ví dụ file `/var/log/checketc.log`:

    ```bash
    [Log checketc - 12:00:00 12/05/2017]
    === Danh sach file tao moi ===
    /etc/hackyou
    He thong cua ban da bi ma hoa. Chuyen 100bitcon vao
    boy_kute_noi_khong_ai_nghe@yahoo.com de giai ma.

    /etc/pam.d/test
    xxxxxxxxxx

    === Danh sach file sua doi ===
    /etc/pam.d/password-auth

    === Danh sach file bi xoa ===
    /etc/shadow
    ```

- `3.3.` Monitor SSH: Viết shell script `sshmonitor.sh` đặt lịch chạy định kỳ 5 phút/lần để thực hiện:

  - `1.` List danh sách các phiên đăng nhập mới qua ssh
  - `2.` Nếu phát hiện có phiên đăng nhập mới (so với lần chạy trước) thì gửi email cho quản trị viên root@localhost.
  - Ví dụ nội dung mail:
    ```bash
    User root dang nhap thanh cong vao thoi gian 12:00:00 12/05/2017
    ```

- `3.4.` Cài đặt webserver: Cài đặt webserver apache2. Tạo một file html trong thư mục gốc của webserver. Đơn giản có nội dung sau: "<h1>Hello world, apache2</h1>". Sử dụng lệnh curl kiểm tra truy cập vào file html vừa tạo.

- `3.5.` Cấu hình virtual hosts cho webserver: Tạo hai virtual hosts web1 và web2 cho webserver. Trên mối virtual hosts tạo một file index.html chứa nội dung tên virtual hosts. Sử dụng file /etc/hosts để tạo hai domain web1.com và web2.com.

  - Ví dụ: web1.com 127.0.0.1 có file index.html chứa nội dung web1

- `3.6.` Cài đặt mysql, php, wordpress: Cài đặt mysql, php sau đó cài đặt wordpress bản mới nhất cho web1.

### 3.4. ; 3.5. ; 3.6.

> 3.4.

- Để cài đặt và cấu hình web server Apache2 trên Ubuntu, bạn có thể thực hiện các bước sau:

### 1. Cài đặt Apache2:

```bash
sudo apt update
sudo apt install apache2
```

### 2. Tạo file HTML trong thư mục gốc của webserver:

```bash
echo "<h1>Hello world, apache2</h1>" | sudo tee /var/www/html/index.html
```

### 3. Kiểm tra truy cập file HTML bằng lệnh curl:

```bash
curl http://localhost
```

Lệnh trên sẽ trả về nội dung của trang HTML từ web server local. Nếu bạn muốn kiểm tra từ một máy tính khác trong cùng mạng, bạn cần thay đổi địa chỉ IP của máy chủ trong lệnh curl.

Ví dụ, nếu IP của máy chủ là 192.168.1.100, bạn có thể chạy lệnh:

```bash
curl http://192.168.1.100
```

Nếu mọi thứ đúng, bạn sẽ nhận được phản hồi với nội dung HTML được tạo.

Lưu ý: Đảm bảo rằng tường lửa trên máy chủ đã được cấu hình để cho phép kết nối đến cổng 80, nơi Apache2 mặc định lắng nghe.

> 3.5.

Để cấu hình Virtual Hosts cho web server Apache2 và tạo hai domain `web1.com` và `web2.com`, bạn có thể thực hiện các bước sau:

### 1. Tạo hai file index.html cho mỗi Virtual Host:

```bash
echo "<h1>web1</h1>" | sudo tee /var/www/web1/index.html
echo "<h1>web2</h1>" | sudo tee /var/www/web2/index.html
```

### 2. Tạo thư mục cho mỗi Virtual Host:

```bash
sudo mkdir /var/www/web1
sudo mkdir /var/www/web2
```

### 3. Tạo và chỉnh sửa file cấu hình Virtual Hosts:

```bash
# Tạo file cấu hình cho web1
sudo nano /etc/apache2/sites-available/web1.conf
```

Thêm nội dung sau vào file:

```apache
<VirtualHost *:80>
    ServerAdmin webmaster@web1.com
    ServerName web1.com
    DocumentRoot /var/www/web1
    ErrorLog ${APACHE_LOG_DIR}/error.log
    CustomLog ${APACHE_LOG_DIR}/access.log combined
</VirtualHost>
```

Lưu và đóng file.

```bash
# Tạo file cấu hình cho web2
sudo nano /etc/apache2/sites-available/web2.conf
```

Thêm nội dung sau vào file:

```apache
<VirtualHost *:80>
    ServerAdmin webmaster@web2.com
    ServerName web2.com
    DocumentRoot /var/www/web2
    ErrorLog ${APACHE_LOG_DIR}/error.log
    CustomLog ${APACHE_LOG_DIR}/access.log combined
</VirtualHost>
```

Lưu và đóng file.

### 4. Kích hoạt Virtual Hosts và khởi động lại Apache:

```bash
# Kích hoạt virtual hosts
sudo a2ensite web1.conf
sudo a2ensite web2.conf

# Khởi động lại Apache
sudo systemctl restart apache2
```

### 5. Chỉnh sửa file `/etc/hosts`:

```bash
sudo nano /etc/hosts
```

Thêm dòng sau vào cuối file:

```
127.0.0.1 web1.com
127.0.0.1 web2.com
```

Lưu và đóng file.

### 6. Kiểm tra truy cập từ trình duyệt:

Truy cập `http://web1.com` và `http://web2.com` từ trình duyệt. Bạn sẽ thấy nội dung tương ứng với mỗi Virtual Host.

Lưu ý: Đôi khi, sau khi thay đổi cấu hình, bạn có thể cần xóa bộ nhớ cache DNS của trình duyệt hoặc sử dụng trình duyệt ẩn danh để kiểm tra địa chỉ web mới.

> 3.6.

Để cài đặt MySQL, PHP, và WordPress trên Ubuntu, bạn có thể thực hiện các bước sau:

### 1. Cài đặt MySQL:

```bash
sudo apt update
sudo apt install mysql-server
sudo mysql_secure_installation
```

### 2. Cài đặt PHP và các extension cần thiết:

```bash
sudo apt install php libapache2-mod-php php-mysql php-curl php-gd php-mbstring php-xml php-xmlrpc php-soap php-intl php-zip
```

### 3. Khởi động lại Apache để áp dụng thay đổi:

```bash
sudo systemctl restart apache2
```

### 4. Cài đặt WordPress:

#### 4.1. Tải và giải nén WordPress:

```bash
cd /tmp
wget https://wordpress.org/latest.tar.gz
tar xf latest.tar.gz
```

#### 4.2. Di chuyển WordPress vào thư mục DocumentRoot của Virtual Host web1:

```bash
sudo cp -R /tmp/wordpress/* /var/www/web1/
```

#### 4.3. Tạo cơ sở dữ liệu MySQL cho WordPress:

```bash
sudo mysql -u root -p
```

Trong MySQL, thực hiện các câu lệnh sau:

```sql
CREATE DATABASE wordpress;
CREATE USER 'wordpressuser'@'localhost' IDENTIFIED BY 'password';
GRANT ALL PRIVILEGES ON wordpress.* TO 'wordpressuser'@'localhost';
FLUSH PRIVILEGES;
EXIT;
```

Thay thế `'password'` bằng mật khẩu bạn muốn sử dụng.

#### 4.4. Cấu hình WordPress:

```bash
sudo cp /var/www/web1/wp-config-sample.php /var/www/web1/wp-config.php
sudo nano /var/www/web1/wp-config.php
```

Sửa các thông số sau trong file `wp-config.php`:

```php
define('DB_NAME', 'wordpress');
define('DB_USER', 'wordpressuser');
define('DB_PASSWORD', 'password');
define('DB_HOST', 'localhost');
```

Thay thế `'password'` bằng mật khẩu bạn đã chọn.

### 5. Phân quyền cho WordPress:

```bash
sudo chown -R www-data:www-data /var/www/web1
sudo chmod -R 755 /var/www/web1
```

### 6. Truy cập WordPress từ trình duyệt:

Mở trình duyệt và truy cập `http://web1.com`. Bạn sẽ bắt đầu quá trình cài đặt WordPress. Nhập thông tin cần thiết và hoàn tất quá trình cài đặt.

Lưu ý: Đảm bảo đã thêm địa chỉ `web1.com` vào file `/etc/hosts`.

## [3]. References:

- Google

- Linux LPIC
