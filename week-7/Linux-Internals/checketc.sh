#!/bin/bash

# Đường dẫn tới file log
LOG_FILE="/var/log/checketc.log"

# Thời gian hiện tại
CURRENT_TIME=$(date +"%H:%M:%S %d/%m/%Y")

# Thực hiện kiểm tra và ghi log
{
  echo "[Log checketc - $CURRENT_TIME]"

  # 1. Kiểm tra thư mục /etc có file nào được tạo mới không?
  echo "=== Danh sach file tao moi ==="
  find /etc -type f -cmin -30 | while read -r file; do
    echo "$file"
    if [ "$(file -b --mime-type "$file")" == "text/plain" ]; then
      head "$file"
    fi
  done

  # 2. Kiểm tra thư mục /etc có file nào thay đổi không?
  echo "=== Danh sach file sua doi ==="
  find /etc -type f -mmin -30 | while read -r file; do
    echo "$file"
  done

  # 3. Thư mục /etc có file nào bị xóa không?
  echo "=== Danh sach file bi xoa ==="
  comm -23 <(ls -1 /etc | sort) <(find /etc -type f | xargs -n 1 basename | sort) | while read -r file; do
    echo "$file"
  done

} >> "$LOG_FILE"

# 4. Đẩy log ra file /var/log/checketc.log

# 5. Gửi email cho quản trị viên root@localhost
mail -s "Log checketc - $CURRENT_TIME" root@localhost < "$LOG_FILE"
